[üóø]
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Main CBT Simulator - Multi-Question Images</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Dark Mode Variables */
        :root {
            --bg-color: #f5f7fa;
            --text-color: #333;
            --panel-bg: #ffffff;
            --panel-border: #e0e0e0;
            --header-bg-1: #1a237e;
            --header-bg-2: #283593;
            --input-bg: #ffffff;
            --input-border: #ddd;
            --button-bg: #f5f5f5;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --timer-bg: #1a237e;
        }
        
        body.dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --panel-bg: #2d2d2d;
            --panel-border: #404040;
            --header-bg-1: #0d1117;
            --header-bg-2: #161b22;
            --input-bg: #2d2d2d;
            --input-border: #404040;
            --button-bg: #404040;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --timer-bg: #0d1117;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen Styles */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a237e, #283593);
            transition: background 0.3s;
        }
        
        body.dark-mode .login-screen {
            background: linear-gradient(135deg, #0d1117, #161b22);
        }

        .login-box {
            background-color: var(--panel-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
            position: relative;
            transition: background-color 0.3s;
        }

        .login-title {
            font-size: 28px;
            color: var(--text-color);
            margin-bottom: 30px;
            text-align: center;
            transition: color 0.3s;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s, background-color 0.3s;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3f51b5;
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }
        
        body.dark-mode .input-group input,
        body.dark-mode .input-group select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--input-border);
        }

        .test-config {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid var(--panel-border);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .config-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .config-col {
            flex: 1;
        }

        /* Header Styles - Hidden as per user request */
        header {
            display: none;
        }

        .header-left h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-left .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-right {
            text-align: right;
        }

        .user-info {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .test-info {
            font-size: 13px;
            opacity: 0.8;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .left-panel {
            flex: 1;
            min-width: 300px;
            background-color: var(--panel-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .right-panel {
            width: 320px;
            background-color: var(--panel-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .subject-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
            justify-content: space-between;
        }
        
        .timer-in-tabs {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            padding: 10px 16px;
            border-radius: 6px 6px 0 0;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 0.5px;
            white-space: nowrap;
            margin-left: auto;
        }
        
        .timer-in-tabs #timer {
            font-family: monospace;
            font-size: 18px;
            color: #ffeb3b;
        }

        .subject-tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .subject-tab.active {
            background-color: #3f51b5;
            color: white;
            box-shadow: 0 -2px 0 #1a237e inset;
        }

        .subject-tab.inactive {
            background-color: var(--button-bg);
            color: var(--text-color);
            opacity: 0.75;
        }

        .subject-tab.inactive:hover {
            background-color: #e8eaf6;
            opacity: 1;
        }
        
        body.dark-mode .subject-tab.inactive:hover {
            background-color: #3a3f6b;
        }

        .question-container {
            text-align: center;
            margin-bottom: 25px;
        }

        #question-number {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
            background: var(--panel-bg);
            padding: 8px 14px;
            border-radius: 6px;
            border-left: 4px solid #3f51b5;
            display: inline-block;
        }

        .image-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .image-nav-btn {
            padding: 8px 16px;
            background-color: #3f51b5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .image-nav-btn:hover {
            background-color: #303f9f;
        }

        .image-nav-btn:disabled {
            background-color: #9fa8da;
            cursor: not-allowed;
        }

        #image-counter {
            font-weight: 600;
            color: #3f51b5;
        }

        .question-image {
            max-width: 100%;
            max-height: 500px;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            box-shadow: 0 3px 6px var(--shadow-color);
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s;
            cursor: zoom-in;
        }
        
        .question-image:hover {
            box-shadow: 0 6px 16px rgba(63,81,181,0.25);
            transform: scale(1.01);
        }
        
        body.dark-mode .question-image {
            filter: brightness(0.9);
        }

        /* Fullscreen Image Overlay */
        #img-fullscreen-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
            animation: fadeInOverlay 0.2s ease;
        }
        @keyframes fadeInOverlay { from{opacity:0} to{opacity:1} }
        #img-fullscreen-overlay.active { display: flex; }
        #img-fullscreen-img {
            max-width: 95vw;
            max-height: 92vh;
            border-radius: 6px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.6);
            animation: zoomIn 0.2s ease;
            object-fit: contain;
            user-select: none;
        }
        @keyframes zoomIn { from{transform:scale(0.88);opacity:0} to{transform:scale(1);opacity:1} }
        #img-fullscreen-close {
            position: fixed;
            top: 16px; right: 20px;
            color: white;
            font-size: 26px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10000;
            background: rgba(255,255,255,0.12);
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
        }
        #img-fullscreen-close:hover { opacity:1; transform:scale(1.1); background:rgba(255,255,255,0.22); }
        #img-fullscreen-hint {
            position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
            color: rgba(255,255,255,0.45); font-size: 13px; pointer-events: none;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .option {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            background-color: var(--panel-bg);
            color: var(--text-color);
            font-size: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px var(--shadow-color);
        }

        .option:hover {
            background-color: #e8eaf6;
            border-color: #9fa8da;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(63,81,181,0.15);
        }

        .option.selected {
            background-color: #3f51b5;
            border-color: #1a237e;
            color: #ffffff;
            box-shadow: 0 3px 10px rgba(63,81,181,0.4);
        }
        
        .option.selected span {
            background: rgba(255,255,255,0.25) !important;
            color: white !important;
        }
        
        body.dark-mode .option {
            border-color: #555;
        }
        
        body.dark-mode .option:hover {
            background-color: #3a3f6b;
            border-color: #7986cb;
        }
        
        body.dark-mode .option.selected {
            background-color: #3f51b5;
            border-color: #5c6bc0;
            color: white;
        }

        .question-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 15px;
        }

        .btn-primary {
            background-color: #3f51b5;
            color: white;
        }

        .btn-primary:hover {
            background-color: #303f9f;
        }

        .btn-secondary {
            background-color: var(--button-bg);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        body.dark-mode .btn-secondary:hover {
            background-color: #555;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-success {
            background-color: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background-color: #388e3c;
        }

        .btn-warning {
            background-color: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background-color: #ef6c00;
        }

        .btn-info {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #1976d2;
        }

        .timer-container {
            background-color: var(--timer-bg);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }

        #timer {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 1px;
            font-family: monospace;
        }
        
        /* Default: badge-short hidden, badge-label visible */
        .badge-short { display: none; }
        @media (max-width: 900px) {
            .timer-container {
                padding: 8px 12px;
                border-radius: 8px;
            }
            
            .timer-container > div:first-child,
            .timer-container > div:last-child {
                display: none;
            }
            
            #timer {
                font-size: 18px;
                letter-spacing: 1px;
            }
            
            .timer-container::before {
                content: '‚è±';
                font-size: 15px;
            }
            
            /* Badge completely hidden as per user request */
            #current-question-badge {
                display: none !important;
            }
        }

        .question-palette {
            margin-bottom: 25px;
            display: none; /* Initially hidden */
            transition: all 0.3s ease;
        }
        
        .question-palette.show {
            display: block;
        }
        
        /* Auto-advance toggle */
        #auto-advance-toggle:checked + .toggle-slider {
            background-color: #3f51b5;
        }
        #auto-advance-toggle:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        .palette-toggle-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3f51b5, #5c6bc0);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(63, 81, 181, 0.3);
        }
        
        .palette-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(63, 81, 181, 0.4);
        }
        
        .palette-toggle-btn:active {
            transform: translateY(0);
        }

        .palette-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .palette-subject {
            margin-bottom: 20px;
        }

        .subject-label {
            font-weight: 600;
            color: #3f51b5;
            margin-bottom: 10px;
            display: block;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--panel-border);
            font-size: 13px;
        }

        .palette-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .palette-btn {
            width: 100%;
            padding: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            background-color: #f9f9f9;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        body.dark-mode .palette-btn.not-visited {
            background-color: #3a3a3a;
            color: #aaa;
            border-color: #555;
        }
        
        body.dark-mode .palette-btn.not-answered {
            background-color: #4a1a1a;
            color: #ff8a80;
            border-color: #c62828;
        }
        
        body.dark-mode .palette-btn.answered {
            background-color: #1a3a1a;
            color: #69f0ae;
            border-color: #2e7d32;
        }
        
        body.dark-mode .palette-btn.marked {
            background-color: #555;
            color: #ddd;
            border-color: #777;
        }

        .palette-btn.not-visited {
            background-color: #f5f5f5;
            color: #666;
        }

        .palette-btn.not-answered {
            background-color: #ffebee;
            color: #c62828;
            border-color: #ef9a9a;
        }

        .palette-btn.answered {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-color: #a5d6a7;
        }

        .palette-btn.marked {
            background-color: #9e9e9e;
            color: #ffffff;
            border-color: #757575;
        }

        .palette-btn.current {
            border: 2px solid #1a237e;
            font-weight: bold;
            box-shadow: 0 0 0 2px rgba(63,81,181,0.5), inset 0 0 0 2px rgba(255,255,255,0.4);
            transform: scale(1.08);
            position: relative;
            z-index: 1;
        }
        
        /* When current + answered: keep green bg but strong blue border */
        .palette-btn.current.answered {
            border: 2px solid #1a237e;
        }
        /* When current + marked: keep gray bg but strong blue border */
        .palette-btn.current.marked {
            border: 2px solid #1a237e;
        }
        /* When current + not-answered: keep red bg but strong blue border */
        .palette-btn.current.not-answered {
            border: 2px solid #1a237e;
        }

        .instructions {
            background-color: var(--button-bg);
            border: 1px solid var(--panel-border);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: var(--text-color);
        }

        .instructions h3 {
            color: #3f51b5;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #1a237e;
        }

        .answer-key-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background-color: #f9f9f9;
        }

        .answer-key-section h4 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #3f51b5;
            padding-bottom: 8px;
        }

        .answer-key-images {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .answer-key-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .answer-key-image:hover {
            transform: scale(1.01);
        }

        .answer-input-container {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .answer-input-container h5 {
            margin-bottom: 10px;
            color: #555;
        }

        .answer-input-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #3f51b5;
            border-radius: 6px;
            font-size: 16px;
            font-family: monospace;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .answer-input-box:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .answer-input-info {
            margin-top: 8px;
            font-size: 13px;
            color: #666;
        }

        .answer-input-info .highlight {
            color: #d32f2f;
            font-weight: bold;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .result-table th {
            background-color: #3f51b5;
            color: white;
        }

        .result-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-box {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3f51b5;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .highlight {
            color: #d32f2f;
            font-weight: bold;
        }

        .success {
            color: #2e7d32;
            font-weight: bold;
        }

        .warning {
            color: #ef6c00;
            font-weight: bold;
        }

        .time-spent-table {
            margin-top: 20px;
        }

        .time-spent-table td {
            padding: 8px;
        }

        .time-bar-container {
            width: 100%;
            background-color: #f5f5f5;
            border-radius: 4px;
            overflow: hidden;
            height: 20px;
        }

        .time-bar {
            height: 100%;
            background-color: #4caf50;
            border-radius: 4px;
        }

        /* Final Screen */
        .final-screen {
            text-align: center;
            padding: 40px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .final-icon {
            font-size: 80px;
            color: #4caf50;
            margin-bottom: 20px;
        }

        .final-title {
            font-size: 32px;
            color: #1a237e;
            margin-bottom: 15px;
        }

        .final-message {
            font-size: 18px;
            margin-bottom: 30px;
            color: #555;
        }

        /* Enhanced Results Styles */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .insight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.3s;
        }

        .insight-box:hover {
            transform: translateY(-5px);
        }

        .insight-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .insight-title {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .insight-detail {
            font-size: 12px;
            opacity: 0.8;
        }

        .strength-weakness-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .strength-box, .weakness-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
        }

        .strength-box {
            border-left: 5px solid #4caf50;
        }

        .weakness-box {
            border-left: 5px solid #f44336;
        }

        .strength-box li, .weakness-box li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .strength-box li:last-child, .weakness-box li:last-child {
            border-bottom: none;
        }

        .distribution-container {
            margin-bottom: 25px;
        }

        .distribution-bar {
            display: flex;
            height: 50px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .bar-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 0.5s ease;
            position: relative;
        }

        .correct-bar {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
        }

        .incorrect-bar {
            background: linear-gradient(135deg, #f44336, #ef5350);
        }

        .unattempted-bar {
            background: linear-gradient(135deg, #9e9e9e, #bdbdbd);
        }

        .bar-label {
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .distribution-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* Test History Styles */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .history-item {
            background-color: #f9f9f9;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        
        .history-item:hover {
            background-color: #e8eaf6;
            border-color: #3f51b5;
            transform: translateX(5px);
        }
        
        .history-item.selected {
            background-color: #c5cae9;
            border-color: #1a237e;
        }
        
        .history-date {
            font-weight: bold;
            color: #1a237e;
            min-width: 150px;
        }
        
        .history-score {
            font-size: 18px;
            font-weight: bold;
            color: #4caf50;
        }
        
        .history-subjects {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #666;
        }
        
        .history-subject-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .history-subject-score {
            font-weight: bold;
            color: #3f51b5;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
        }
        
        .history-action-btn {
            padding: 5px 15px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .history-view-btn {
            background-color: #3f51b5;
            color: white;
        }
        
        .history-view-btn:hover {
            background-color: #303f9f;
        }
        
        .history-compare-btn {
            background-color: #ff9800;
            color: white;
        }
        
        .history-compare-btn:hover {
            background-color: #ef6c00;
        }
        
        .history-delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        .history-delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .history-empty {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .comparison-card {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .comparison-card h4 {
            color: #1a237e;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3f51b5;
        }
        
        .comparison-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .comparison-label {
            font-weight: 600;
            color: #555;
        }
        
        .comparison-value {
            font-weight: bold;
        }
        
        .comparison-highlight {
            background-color: #e8f5e8;
            border-radius: 4px;
            padding: 2px 8px;
        }
        
        .winner-badge {
            background-color: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .history-clear-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .history-clear-btn:hover {
            background-color: #d32f2f;
        }

        /* Responsive Styles */
        @media (max-width: 1100px) {
            .main-content {
                flex-direction: column;
            }
            
            .right-panel {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .palette-buttons {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .config-row {
                flex-direction: column;
            }
            
            .question-actions {
                flex-wrap: wrap;
            }
            
            .image-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
            
            .strength-weakness-grid {
                grid-template-columns: 1fr;
            }
            
            .history-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .history-subjects {
                flex-wrap: wrap;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .palette-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .subject-tabs {
                flex-wrap: wrap;
            }
            
            .subject-tab {
                flex: 1;
                min-width: 100px;
                text-align: center;
                margin-bottom: 5px;
            }
            
            .login-box {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <button id="dark-mode-toggle-login" style="position: absolute; top: 20px; right: 20px; padding: 8px 15px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 20px; color: #333; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                üåô Dark Mode
            </button>
            <h2 class="login-title">JEE Main CBT Simulator</h2>
            
            <div class="input-group">
                <label for="user-name">Enter Your Name</label>
                <input type="text" id="user-name" placeholder="Enter your name">
            </div>
            
            <div class="input-group">
                <label for="test-name">Test Name (Optional)</label>
                <input type="text" id="test-name" placeholder="e.g., Mock Test 1, Physics Practice">
            </div>
            
            <div class="input-group">
                <label for="test-type">Select Test Type</label>
                <select id="test-type">
                    <option value="full">Full Mock Test (75 Questions)</option>
                    <option value="custom">Custom Test</option>
                </select>
            </div>
            
            <div id="custom-test-config" class="test-config" style="display: none;">
                <div class="config-row">
                    <div class="config-col">
                        <label for="physics-count">Physics Questions</label>
                        <input type="number" id="physics-count" min="0" max="100" value="10">
                    </div>
                    <div class="config-col">
                        <label for="maths-count">Maths Questions</label>
                        <input type="number" id="maths-count" min="0" max="100" value="10">
                    </div>
                    <div class="config-col">
                        <label for="chemistry-count">Chemistry Questions</label>
                        <input type="number" id="chemistry-count" min="0" max="100" value="10">
                    </div>
                </div>
                
                <!-- Image Files Selection Section -->
                <div style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="margin-bottom: 15px; color: #1976d2;">üìÅ Select Question Images</h3>
                    
                    <!-- Physics Images -->
                    <div class="config-row">
                        <div class="config-col">
                            <label>Physics Images (Max 25)</label>
                            <div id="physics-drop-zone" style="border: 2px dashed #3f51b5; padding: 20px; text-align: center; border-radius: 8px; background: #f5f5f5; margin: 10px 0; cursor: pointer;">
                                <p style="margin: 0; color: #666;">üñ±Ô∏è Click to select or drag & drop images here</p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Select multiple files (Ctrl+A to select all in folder)</p>
                            </div>
                            <input type="file" id="physics-images" multiple accept="image/*" style="display: none;">
                            <small id="physics-count-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 images selected</small>
                        </div>
                    </div>
                    
                    <!-- Maths Images -->
                    <div class="config-row">
                        <div class="config-col">
                            <label>Maths Images (Max 25)</label>
                            <div id="maths-drop-zone" style="border: 2px dashed #3f51b5; padding: 20px; text-align: center; border-radius: 8px; background: #f5f5f5; margin: 10px 0; cursor: pointer;">
                                <p style="margin: 0; color: #666;">üñ±Ô∏è Click to select or drag & drop images here</p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Select multiple files (Ctrl+A to select all in folder)</p>
                            </div>
                            <input type="file" id="maths-images" multiple accept="image/*" style="display: none;">
                            <small id="maths-count-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 images selected</small>
                        </div>
                    </div>
                    
                    <!-- Chemistry Images -->
                    <div class="config-row">
                        <div class="config-col">
                            <label>Chemistry Images (Max 25)</label>
                            <div id="chemistry-drop-zone" style="border: 2px dashed #3f51b5; padding: 20px; text-align: center; border-radius: 8px; background: #f5f5f5; margin: 10px 0; cursor: pointer;">
                                <p style="margin: 0; color: #666;">üñ±Ô∏è Click to select or drag & drop images here</p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Select multiple files (Ctrl+A to select all in folder)</p>
                            </div>
                            <input type="file" id="chemistry-images" multiple accept="image/*" style="display: none;">
                            <small id="chemistry-count-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 images selected</small>
                        </div>
                    </div>
                    
                    <h3 style="margin: 20px 0 15px 0; color: #1976d2;">üîë Select Answer Key Images</h3>
                    
                    <!-- Physics Answers -->
                    <div class="config-row">
                        <div class="config-col">
                            <label>Physics Answers (Max 3 images OR up to 3 txt files)</label>
                            <div id="physics-ans-drop-zone" style="border: 2px dashed #ff9800; padding: 15px; text-align: center; border-radius: 8px; background: #fff3e0; margin: 10px 0; cursor: pointer;">
                                <p style="margin: 0; color: #666;">üñ±Ô∏è Click to select or drag & drop answer images</p>
                            </div>
                            <input type="file" id="physics-answers" multiple accept="image/*" style="display: none;">
                            <small id="physics-ans-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 images selected</small>
                            <div style="margin-top: 8px; padding: 10px; background: #e8f5e9; border: 1px dashed #4caf50; border-radius: 6px; cursor: pointer;" id="physics-txt-drop-zone">
                                <p style="margin: 0; color: #555; font-size: 13px;">üìÑ Or click to select Answer .txt file(s) (Max 3, up to 100 answers each)</p>
                                <p style="margin: 3px 0 0 0; font-size: 11px; color: #888;">Format: A A BC C BB B (spaces are ignored automatically ‚úì)</p>
                            </div>
                            <input type="file" id="physics-answers-txt" multiple accept=".txt" style="display: none;">
                            <div id="physics-txt-ranges" style="margin-top: 6px; display: none;"></div>
                            <small id="physics-txt-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 txt files selected</small>
                        </div>
                    </div>
                    
                    <!-- Maths Answers -->
                    <div class="config-row">
                        <div class="config-col">
                            <label>Maths Answers (Max 3 images OR up to 3 txt files)</label>
                            <div id="maths-ans-drop-zone" style="border: 2px dashed #ff9800; padding: 15px; text-align: center; border-radius: 8px; background: #fff3e0; margin: 10px 0; cursor: pointer;">
                                <p style="margin: 0; color: #666;">üñ±Ô∏è Click to select or drag & drop answer images</p>
                            </div>
                            <input type="file" id="maths-answers" multiple accept="image/*" style="display: none;">
                            <small id="maths-ans-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 images selected</small>
                            <div style="margin-top: 8px; padding: 10px; background: #e8f5e9; border: 1px dashed #4caf50; border-radius: 6px; cursor: pointer;" id="maths-txt-drop-zone">
                                <p style="margin: 0; color: #555; font-size: 13px;">üìÑ Or click to select Answer .txt file(s) (Max 3, up to 100 answers each)</p>
                                <p style="margin: 3px 0 0 0; font-size: 11px; color: #888;">Format: A A BC C BB B (spaces are ignored automatically ‚úì)</p>
                            </div>
                            <input type="file" id="maths-answers-txt" multiple accept=".txt" style="display: none;">
                            <div id="maths-txt-ranges" style="margin-top: 6px; display: none;"></div>
                            <small id="maths-txt-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 txt files selected</small>
                        </div>
                    </div>
                    
                    <!-- Chemistry Answers -->
                    <div class="config-row">
                        <div class="config-col">
                            <label>Chemistry Answers (Max 3 images OR up to 3 txt files)</label>
                            <div id="chemistry-ans-drop-zone" style="border: 2px dashed #ff9800; padding: 15px; text-align: center; border-radius: 8px; background: #fff3e0; margin: 10px 0; cursor: pointer;">
                                <p style="margin: 0; color: #666;">üñ±Ô∏è Click to select or drag & drop answer images</p>
                            </div>
                            <input type="file" id="chemistry-answers" multiple accept="image/*" style="display: none;">
                            <small id="chemistry-ans-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 images selected</small>
                            <div style="margin-top: 8px; padding: 10px; background: #e8f5e9; border: 1px dashed #4caf50; border-radius: 6px; cursor: pointer;" id="chemistry-txt-drop-zone">
                                <p style="margin: 0; color: #555; font-size: 13px;">üìÑ Or click to select Answer .txt file(s) (Max 3, up to 100 answers each)</p>
                                <p style="margin: 3px 0 0 0; font-size: 11px; color: #888;">Format: A A BC C BB B (spaces are ignored automatically ‚úì)</p>
                            </div>
                            <input type="file" id="chemistry-answers-txt" multiple accept=".txt" style="display: none;">
                            <div id="chemistry-txt-ranges" style="margin-top: 6px; display: none;"></div>
                            <small id="chemistry-txt-info" style="color: #666; display: block; margin-top: 5px; font-weight: bold;">0 txt files selected</small>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <strong>üí° How to select multiple images:</strong>
                        <ul style="margin: 5px 0 0 20px; font-size: 13px;">
                            <li><strong>Method 1:</strong> Click drop zone ‚Üí Press <strong>Ctrl+A</strong> to select all images in folder</li>
                            <li><strong>Method 2:</strong> Click drop zone ‚Üí <strong>Ctrl+Click</strong> to select specific files</li>
                            <li><strong>Method 3:</strong> <strong>Drag & drop</strong> multiple files from your folder</li>
                            <li>Each click ADDS images (doesn't replace previous ones)</li>
                            <li>Images can have ANY name, any format (.jpg, .png, etc.)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="test-time">Test Time (minutes)</label>
                    <input type="number" id="test-time" min="1" max="300" value="180">
                </div>
                
                <div class="input-group" style="display: flex; align-items: center; gap: 15px; background: #f0f4ff; padding: 12px 16px; border-radius: 8px; border: 1px solid #c5cae9;">
                    <label for="auto-advance-toggle" style="margin: 0; font-weight: 600; cursor: pointer; flex: 1;">
                        üîÑ Auto-Advance Image with Question
                        <div style="font-size: 12px; color: #666; font-weight: 400; margin-top: 2px;">When ON: image changes automatically with question; image nav buttons disabled</div>
                    </label>
                    <label class="toggle-switch" style="position: relative; display: inline-block; width: 52px; height: 28px; flex-shrink: 0;">
                        <input type="checkbox" id="auto-advance-toggle" style="opacity: 0; width: 0; height: 0;">
                        <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 28px;"></span>
                    </label>
                </div>
            </div>
            
            <button class="btn btn-primary" id="start-test-btn" style="width: 100%; padding: 15px; margin-top: 20px;">
                Start Test
            </button>
            
            <button class="btn" onclick="viewTestHistory()" style="width: 100%; padding: 15px; margin-top: 15px; background: linear-gradient(135deg, #2e7d32, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                üìä View Test History
            </button>
        </div>
    </div>

    <!-- Main Test Interface (Initially Hidden) -->
    <div class="container" id="test-container" style="display: none;">
        <header>
            <div class="header-left">
                <h1>JEE Main CBT Simulator</h1>
                <p class="subtitle" id="test-config-summary">Full Mock Test | 75 Questions | 180 Minutes</p>
            </div>
            <div class="header-right">
                <div class="user-info">Candidate: <span id="display-user-name">Student</span></div>
                <div class="test-info" id="test-stats">Physics: 10 | Maths: 10 | Chemistry: 10</div>
            </div>
        </header>

        <div class="main-content">
            <!-- Left Panel: Question Display -->
            <div class="left-panel">
                <!-- Subject Tabs -->
                <div class="subject-tabs">
                    <div class="subject-tab active" data-subject="physics">Physics (1-<span id="physics-max">25</span>)</div>
                    <div class="subject-tab inactive" data-subject="maths">Mathematics (<span id="maths-start">26</span>-<span id="maths-max">50</span>)</div>
                    <div class="subject-tab inactive" data-subject="chemistry">Chemistry (<span id="chemistry-start">51</span>-<span id="chemistry-max">75</span>)</div>
                    
                    <!-- Timer in tabs -->
                    <div class="timer-in-tabs">
                        ‚è± <span id="timer">180:00</span> min
                    </div>
                </div>

                <!-- Question Container -->
                <div class="question-container">
                    <div id="question-number">Question 1 of 75 (Physics Q1)</div>
                    
                    <!-- Image Navigation -->
                    <div class="image-navigation">
                        <button class="image-nav-btn" id="prev-image-btn">‚Üê Previous Image</button>
                        <div id="image-counter">Image 1 of 5</div>
                        <button class="image-nav-btn" id="next-image-btn">Next Image ‚Üí</button>
                    </div>
                    
                    <img id="question-image" src="" alt="Question" class="question-image">
                </div>

                <!-- Options Container -->
                <div class="options-container">
                    <div class="option" data-option="A"><span style="display:inline-block;background:#3f51b5;color:white;border-radius:50%;width:26px;height:26px;line-height:26px;text-align:center;margin-right:8px;font-size:13px;flex-shrink:0;">A</span>Option A</div>
                    <div class="option" data-option="B"><span style="display:inline-block;background:#3f51b5;color:white;border-radius:50%;width:26px;height:26px;line-height:26px;text-align:center;margin-right:8px;font-size:13px;flex-shrink:0;">B</span>Option B</div>
                    <div class="option" data-option="C"><span style="display:inline-block;background:#3f51b5;color:white;border-radius:50%;width:26px;height:26px;line-height:26px;text-align:center;margin-right:8px;font-size:13px;flex-shrink:0;">C</span>Option C</div>
                    <div class="option" data-option="D"><span style="display:inline-block;background:#3f51b5;color:white;border-radius:50%;width:26px;height:26px;line-height:26px;text-align:center;margin-right:8px;font-size:13px;flex-shrink:0;">D</span>Option D</div>
                </div>

                <!-- Question Actions -->
                <div class="question-actions">
                    <button class="btn btn-warning" id="mark-review-btn">Mark for Review</button>
                </div>

                <!-- Navigation Buttons -->
                <div class="navigation-buttons">
                    <button class="btn btn-secondary" id="prev-btn">Previous Question</button>
                    <button class="btn btn-primary" id="next-btn">Next Question</button>
                </div>

            </div>

            <!-- Right Panel: Question Palette -->
            <div class="right-panel">
                <!-- Old Timer - Hidden as it's now in tabs -->
                <div class="timer-container" style="display: none;">
                    <div>Time Remaining</div>
                    <div id="timer-old">03:00:00</div>
                    <div style="font-size: 14px; margin-top: 5px;">(<span id="total-time-minutes">180</span> minutes)</div>
                </div>
                
                <!-- Current Question Indicator - Hidden as per user request -->
                <div id="current-question-badge" style="display: none;">
                    <span class="badge-label">üìç Current: Question </span><span class="badge-short">Q </span><span id="current-q-number">1</span>
                </div>

                <!-- Palette Toggle Button -->
                <button class="palette-toggle-btn" id="palette-toggle-btn" onclick="togglePalette()">
                    üìã Show Question Palette
                </button>

                <!-- Question Palette -->
                <div class="question-palette" id="question-palette">
                    <div class="palette-title">Question Palette</div>
                    
                    <div class="palette-subject">
                        <span class="subject-label">Physics (1-<span id="palette-physics-max">25</span>)</span>
                        <div class="palette-buttons" id="physics-palette">
                            <!-- Physics buttons will be generated here -->
                        </div>
                    </div>
                    
                    <div class="palette-subject">
                        <span class="subject-label">Mathematics (<span id="palette-maths-start">26</span>-<span id="palette-maths-max">50</span>)</span>
                        <div class="palette-buttons" id="maths-palette">
                            <!-- Maths buttons will be generated here -->
                        </div>
                    </div>
                    
                    <div class="palette-subject">
                        <span class="subject-label">Chemistry (<span id="palette-chemistry-start">51</span>-<span id="palette-chemistry-max">75</span>)</span>
                        <div class="palette-buttons" id="chemistry-palette">
                            <!-- Chemistry buttons will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="instructions">
                    <!-- Test Information moved from header -->
                    <div style="background: linear-gradient(135deg, #1a237e, #283593); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative;">
                        <button id="dark-mode-toggle" style="position: absolute; top: 10px; right: 10px; padding: 8px 15px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; color: white; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                            üåô Dark Mode
                        </button>
                        <h3 style="margin: 0 0 8px 0; font-size: 20px;">JEE Main CBT Simulator</h3>
                        <p style="margin: 0 0 5px 0; font-size: 14px; opacity: 0.9;" id="test-config-summary-instructions">Full Mock Test | 75 Questions | 180 Minutes</p>
                        <p style="margin: 0 0 5px 0; font-size: 14px;">Candidate: <span id="display-user-name-instructions">Student</span></p>
                        <p style="margin: 0; font-size: 13px; opacity: 0.8;" id="test-stats-instructions">Physics: 10 | Maths: 10 | Chemistry: 10</p>
                    </div>
                    
                    <h3 style="display: none;">Instructions:</h3>
                    <ul style="display: none;">
                        <li><strong>Image Navigation:</strong> Use Previous/Next Image buttons</li>
                        <li><strong>Select Question:</strong> Click on question number above image</li>
                        <li><strong>Mark for Review:</strong> Click button to mark question for later review</li>
                        <li><strong>Scoring:</strong> +4 for correct, -1 for incorrect, 0 for unattempted</li>
                        <li><strong>Answer Input:</strong> Enter answers without spaces (e.g., ABCDA)</li>
                        <li>All data is stored locally in your browser</li>
                    </ul>
                </div>

                <!-- Submit Section (Moved here for safety) -->
                <div style="margin-top: 20px; background: #fff3f3; border: 1px solid #ffcdd2; border-radius: 10px; padding: 15px;">
                    <div style="font-size: 13px; color: #c62828; font-weight: 600; margin-bottom: 10px; text-align: center;">
                        ‚ö†Ô∏è Submit Test
                    </div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: #555; margin-bottom: 12px; user-select: none;">
                        <input type="checkbox" id="submit-confirm-check" onchange="toggleSubmitBtn()" style="width: 16px; height: 16px; cursor: pointer; accent-color: #f44336;">
                        I want to submit the test
                    </label>
                    <button class="btn btn-danger" id="submit-btn" disabled
                        style="width: 100%; padding: 12px; font-size: 15px; font-weight: 700; opacity: 0.4; cursor: not-allowed; transition: opacity 0.3s;">
                        üèÅ Submit Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submission Modal -->
    <div class="modal" id="submission-modal">
        <div class="modal-content">
            <h2 class="modal-title">Test Submission</h2>
            <p>Your test has been submitted. Please enter the correct answers for each subject.</p>
            <p class="highlight">Enter answers without spaces (e.g., ABCDA...)</p>
            
            <!-- Physics Answer Key -->
            <div class="answer-key-section">
                <h4>Physics Answer Key (<span id="physics-key-count">0</span> questions):</h4>
                <div class="answer-key-images" id="physics-answer-images">
                    <!-- Answer key images for physics will be loaded here -->
                </div>
                <div class="answer-input-container">
                    <h5>Enter Physics Answers:</h5>
                    <input type="text" class="answer-input-box" id="physics-answers-input" 
                           maxlength="25" placeholder="ABCDABCDABCDABCDABCDABCDA">
                    <div class="answer-input-info">
                        <span id="physics-answers-length">0</span>/25 characters entered
                        <span class="highlight"> (No spaces, only A/B/C/D)</span>
                    </div>
                </div>
            </div>
            
            <!-- Maths Answer Key -->
            <div class="answer-key-section">
                <h4>Mathematics Answer Key (<span id="maths-key-count">0</span> questions):</h4>
                <div class="answer-key-images" id="maths-answer-images">
                    <!-- Answer key images for maths will be loaded here -->
                </div>
                <div class="answer-input-container">
                    <h5>Enter Mathematics Answers:</h5>
                    <input type="text" class="answer-input-box" id="maths-answers-input" 
                           maxlength="25" placeholder="ABCDABCDABCDABCDABCDABCDA">
                    <div class="answer-input-info">
                        <span id="maths-answers-length">0</span>/25 characters entered
                        <span class="highlight"> (No spaces, only A/B/C/D)</span>
                    </div>
                </div>
            </div>
            
            <!-- Chemistry Answer Key -->
            <div class="answer-key-section">
                <h4>Chemistry Answer Key (<span id="chemistry-key-count">0</span> questions):</h4>
                <div class="answer-key-images" id="chemistry-answer-images">
                    <!-- Answer key images for chemistry will be loaded here -->
                </div>
                <div class="answer-input-container">
                    <h5>Enter Chemistry Answers:</h5>
                    <input type="text" class="answer-input-box" id="chemistry-answers-input" 
                           maxlength="25" placeholder="ABCDABCDABCDABCDABCDABCDA">
                    <div class="answer-input-info">
                        <span id="chemistry-answers-length">0</span>/25 characters entered
                        <span class="highlight"> (No spaces, only A/B/C/D)</span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn btn-secondary" id="cancel-submit-btn">Cancel</button>
                <button class="btn btn-primary" id="calculate-results-btn">Calculate Results</button>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal" id="results-modal">
        <div class="modal-content">
            <h2 class="modal-title">Test Results</h2>
            <p>Candidate: <strong id="results-user-name">Student</strong> | Test: <strong id="results-test-name">Test</strong></p>
            
            <!-- Overall Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="total-score">0</div>
                    <div class="stat-label">Total Score</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-correct">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-incorrect">0</div>
                    <div class="stat-label">Incorrect Answers</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-unattempted">0</div>
                    <div class="stat-label">Unattempted</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-marked">0</div>
                    <div class="stat-label">Marked for Review</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="accuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="time-taken">00:00</div>
                    <div class="stat-label">Time Taken</div>
                </div>
            </div>

            <!-- Subject-wise Stats -->
            <h3 style="margin: 25px 0 15px 0; color: #1a237e;">Subject-wise Performance</h3>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Questions</th>
                        <th>Score</th>
                        <th>Correct</th>
                        <th>Incorrect</th>
                        <th>Marked</th>
                        <th>Accuracy</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Physics</td>
                        <td id="physics-total">0</td>
                        <td id="physics-score">0</td>
                        <td id="physics-correct">0</td>
                        <td id="physics-incorrect">0</td>
                        <td id="physics-marked">0</td>
                        <td id="physics-accuracy">0%</td>
                    </tr>
                    <tr>
                        <td>Mathematics</td>
                        <td id="maths-total">0</td>
                        <td id="maths-score">0</td>
                        <td id="maths-correct">0</td>
                        <td id="maths-incorrect">0</td>
                        <td id="maths-marked">0</td>
                        <td id="maths-accuracy">0%</td>
                    </tr>
                    <tr>
                        <td>Chemistry</td>
                        <td id="chemistry-total">0</td>
                        <td id="chemistry-score">0</td>
                        <td id="chemistry-correct">0</td>
                        <td id="chemistry-incorrect">0</td>
                        <td id="chemistry-marked">0</td>
                        <td id="chemistry-accuracy">0%</td>
                    </tr>
                </tbody>
            </table>

            <!-- Time Spent Analysis -->
            <h3 style="margin: 25px 0 15px 0; color: #1a237e;">Time Spent Analysis</h3>
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <table class="result-table time-spent-table">
                    <thead>
                        <tr>
                            <th>Q.No</th>
                            <th>Subject</th>
                            <th>Time Spent</th>
                            <th>Time Distribution</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="time-spent-results">
                        <!-- Time spent data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Detailed Results -->
            <h3 style="margin: 25px 0 15px 0; color: #1a237e;">Detailed Question-wise Analysis</h3>
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Q.No</th>
                            <th>Your Answer</th>
                            <th>Correct Answer</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Marked</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-results">
                        <!-- Detailed results will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Performance Insights -->
            <h3 style="margin: 25px 0 15px 0; color: #1a237e;">üìä Performance Insights</h3>
            <div class="insights-grid">
                <div class="insight-box">
                    <div class="insight-icon">‚ö°</div>
                    <div class="insight-title">Fastest Subject</div>
                    <div class="insight-value" id="fastest-subject">-</div>
                    <div class="insight-detail" id="fastest-time">-</div>
                </div>
                <div class="insight-box">
                    <div class="insight-icon">üéØ</div>
                    <div class="insight-title">Best Subject</div>
                    <div class="insight-value" id="best-subject">-</div>
                    <div class="insight-detail" id="best-accuracy">-</div>
                </div>
                <div class="insight-box">
                    <div class="insight-icon">‚è±Ô∏è</div>
                    <div class="insight-title">Avg Time/Question</div>
                    <div class="insight-value" id="avg-time-per-q">-</div>
                    <div class="insight-detail">Attempted questions</div>
                </div>
                <div class="insight-box">
                    <div class="insight-icon">üíØ</div>
                    <div class="insight-title">Efficiency Rate</div>
                    <div class="insight-value" id="efficiency-rate">-</div>
                    <div class="insight-detail">Correct/Attempted ratio</div>
                </div>
            </div>

            <!-- Strengths & Weaknesses -->
            <h3 style="margin: 25px 0 15px 0; color: #1a237e;">üí™ Strengths & Areas to Improve</h3>
            <div class="strength-weakness-grid">
                <div class="strength-box">
                    <h4 style="color: #2e7d32; margin-bottom: 10px;">‚úÖ Strengths</h4>
                    <ul id="strengths-list" style="list-style: none; padding: 0;">
                        <!-- Strengths will be populated here -->
                    </ul>
                </div>
                <div class="weakness-box">
                    <h4 style="color: #d32f2f; margin-bottom: 10px;">‚ö†Ô∏è Areas to Improve</h4>
                    <ul id="weaknesses-list" style="list-style: none; padding: 0;">
                        <!-- Weaknesses will be populated here -->
                    </ul>
                </div>
            </div>

            <!-- Question Status Distribution -->
            <h3 style="margin: 25px 0 15px 0; color: #1a237e;">üìà Question Status Distribution</h3>
            <div class="distribution-container">
                <div class="distribution-bar">
                    <div class="bar-segment correct-bar" id="correct-bar" style="width: 0%;">
                        <span class="bar-label" id="correct-bar-label">0</span>
                    </div>
                    <div class="bar-segment incorrect-bar" id="incorrect-bar" style="width: 0%;">
                        <span class="bar-label" id="incorrect-bar-label">0</span>
                    </div>
                    <div class="bar-segment unattempted-bar" id="unattempted-bar" style="width: 0%;">
                        <span class="bar-label" id="unattempted-bar-label">0</span>
                    </div>
                </div>
                <div class="distribution-legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4caf50;"></span>
                        <span>Correct</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #f44336;"></span>
                        <span>Incorrect</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #9e9e9e;"></span>
                        <span>Unattempted</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" id="close-results-btn">Close</button>
                <button class="btn btn-success" id="new-test-btn" style="margin-left: 10px;">Start New Test</button>
            </div>
        </div>
    </div>

    <!-- Test History Modal -->
    <div class="modal" id="history-modal">
        <div class="modal-content">
            <div class="history-header">
                <h2 class="modal-title">üìö Test History</h2>
                <button class="history-clear-btn" id="clear-history-btn">Clear All History</button>
            </div>
            <div id="history-list" class="history-list">
                <!-- History items will be populated here -->
            </div>
            <div style="text-align: center;">
                <button class="btn btn-secondary" id="close-history-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="modal" id="comparison-modal">
        <div class="modal-content">
            <h2 class="modal-title">üÜö Test Comparison</h2>
            <div id="comparison-content" class="comparison-grid">
                <!-- Comparison will be populated here -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" id="close-comparison-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Final Screen (After Results) -->
    <div class="container" id="final-screen" style="display: none;">
        <div class="final-screen">
            <div class="final-icon">‚úÖ</div>
            <h2 class="final-title">Test Completed Successfully!</h2>
            <p class="final-message">Thank you for taking the JEE Main CBT Simulator test.</p>
            <p class="final-message">Your detailed results have been saved and can be viewed again.</p>
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" id="view-results-btn" style="margin-right: 10px;">View Results Again</button>
                <button class="btn btn-info" id="view-history-btn" style="margin-right: 10px;">üìã Test History</button>
                <button class="btn btn-success" id="final-new-test-btn">Start New Test</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestion = 1;
        let currentSubject = 'physics';
        let currentImageIndex = 0;
        let manualImageChange = false; // Track if user manually changed image
        let isSubjectSwitching = false; // Track if switching subjects via tabs
        let timerInterval;
        let totalSeconds = 180 * 60;
        let startTime = new Date();
        let questionStartTime = new Date();
        let testStarted = false;
        let testSubmitted = false;
        
        // Subject state memory - remember last position for each subject
        let subjectMemory = {
            physics: { lastQuestion: 1, lastImageIndex: 0 },
            maths: { lastQuestion: null, lastImageIndex: 0 },
            chemistry: { lastQuestion: null, lastImageIndex: 0 }
        };
        
        // User configuration
        let userName = "";
        let testName = "";
        let testType = "full";
        let physicsCount = 25;
        let mathsCount = 25;
        let chemistryCount = 25;
        let totalQuestions = 75;
        let customTime = 180;
        
        // Answer storage arrays
        let physicsAnswers = [];
        let mathsAnswers = [];
        let chemistryAnswers = [];
        
        // Marked for review arrays
        let physicsMarked = [];
        let mathsMarked = [];
        let chemistryMarked = [];
        
        // Time spent per question
        let timeSpent = [];
        
        // Loaded images from folders (using File API)
        let loadedPhysicsImages = [];
        let loadedMathsImages = [];
        let loadedChemistryImages = [];
        
        // Loaded answer images
        let loadedPhysicsAnswers = [];
        let loadedMathsAnswers = [];
        let loadedChemistryAnswers = [];
        
        // Loaded answer txt keys (auto-fill)
        let physicsTxtAnswerKey = '';  // combined string from all txt files
        let mathsTxtAnswerKey = '';
        let chemistryTxtAnswerKey = '';
        
        // Auto-advance toggle state
        let autoAdvanceImage = false;
        
        // Answer keys (for scoring)
        let physicsKey = [];
        let mathsKey = [];
        let chemistryKey = [];
        
        // Images per subject (multiple questions per image)
        let physicsImages = [];
        let mathsImages = [];
        let chemistryImages = [];
        
        // Answer key images
        let physicsAnswerImages = [];
        let mathsAnswerImages = [];
        let chemistryAnswerImages = [];
        
        // Questions per image (how many questions in each image)
        let questionsPerImage = 10; // Default: 10 questions per image
        
        // Test History Array
        let testHistory = [];

        // Current test data for saving to history
        let currentTestData = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            detectAvailableImages();
            initializeDarkMode();
            loadTestHistory();
            
            // Image fullscreen on click
            document.getElementById('question-image').addEventListener('click', function() {
                if (this.src && !this.src.endsWith('#') && this.naturalWidth > 0) {
                    openFullscreen(this.src);
                }
            });
            
            // Esc key se close
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeFullscreen();
            });
        });
        
        function openFullscreen(src) {
            const overlay = document.getElementById('img-fullscreen-overlay');
            const img = document.getElementById('img-fullscreen-img');
            img.src = src;
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeFullscreen() {
            const overlay = document.getElementById('img-fullscreen-overlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Dark Mode Functions
        function initializeDarkMode() {
            // Check if dark mode preference is saved
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                updateDarkModeButtons(true);
            }
            
            // Add event listeners to both toggle buttons
            const toggleBtnLogin = document.getElementById('dark-mode-toggle-login');
            const toggleBtn = document.getElementById('dark-mode-toggle');
            
            if (toggleBtnLogin) {
                toggleBtnLogin.addEventListener('click', toggleDarkMode);
            }
            
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleDarkMode);
            }
        }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            
            // Save preference
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
                updateDarkModeButtons(true);
            } else {
                localStorage.setItem('darkMode', 'disabled');
                updateDarkModeButtons(false);
            }
        }
        
        function updateDarkModeButtons(isDark) {
            const toggleBtnLogin = document.getElementById('dark-mode-toggle-login');
            const toggleBtn = document.getElementById('dark-mode-toggle');
            
            if (isDark) {
                if (toggleBtnLogin) {
                    toggleBtnLogin.innerHTML = '‚òÄÔ∏è Light Mode';
                    toggleBtnLogin.style.background = '#404040';
                    toggleBtnLogin.style.color = '#e0e0e0';
                    toggleBtnLogin.style.borderColor = '#555';
                }
                if (toggleBtn) {
                    toggleBtn.innerHTML = '‚òÄÔ∏è Light Mode';
                }
            } else {
                if (toggleBtnLogin) {
                    toggleBtnLogin.innerHTML = 'üåô Dark Mode';
                    toggleBtnLogin.style.background = '#f0f0f0';
                    toggleBtnLogin.style.color = '#333';
                    toggleBtnLogin.style.borderColor = '#ddd';
                }
                if (toggleBtn) {
                    toggleBtn.innerHTML = 'üåô Dark Mode';
                }
            }
        }
        
        // Load Test History from localStorage
        function loadTestHistory() {
            const savedHistory = localStorage.getItem('jeeTestHistory');
            if (savedHistory) {
                try {
                    testHistory = JSON.parse(savedHistory);
                    console.log('Loaded test history from localStorage:', testHistory);
                } catch (e) {
                    console.error('Error loading test history:', e);
                    testHistory = [];
                }
            }
        }
        
        // Save Test History to localStorage
        function saveTestHistory() {
            localStorage.setItem('jeeTestHistory', JSON.stringify(testHistory));
        }
        
        // Add current test to history
        function addTestToHistory(testData) {
            testHistory.unshift(testData); // Add to beginning (latest first)
            
            // Keep only last 20 tests to avoid localStorage overflow
            if (testHistory.length > 20) {
                testHistory = testHistory.slice(0, 20);
            }
            
            saveTestHistory();
        }
        
        // Format date for display
        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }
        
        // Format time from seconds to MM:SS
        function formatTimeFromSeconds(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Display Test History Modal
        function showTestHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (testHistory.length === 0) {
                historyList.innerHTML = '<div class="history-empty">üì≠ No test history found. Complete a test to see it here!</div>';
                document.getElementById('history-modal').style.display = 'flex';
                return;
            }
            
            testHistory.forEach((test, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.setAttribute('data-index', index);
                
                const dateStr = formatDate(test.date);
                const totalScore = test.totalScore || 0;
                const maxMarks = test.maxMarks || (test.totalQuestions * 4) || 300;
                const totalQuestions = test.totalQuestions || 75;
                
                let subjectsHtml = '';
                if (test.subjectScores) {
                    console.log('Test data for history item:', test);
                    console.log('subjectTimeSpent object:', test.subjectTimeSpent);
                    console.log('Physics time:', test.subjectTimeSpent?.physics, 'Maths time:', test.subjectTimeSpent?.maths, 'Chemistry time:', test.subjectTimeSpent?.chemistry);
                    
                    const physicsTime = test.subjectTimeSpent ? formatTimeFromSeconds(test.subjectTimeSpent.physics) : '--';
                    const mathsTime = test.subjectTimeSpent ? formatTimeFromSeconds(test.subjectTimeSpent.maths) : '--';
                    const chemistryTime = test.subjectTimeSpent ? formatTimeFromSeconds(test.subjectTimeSpent.chemistry) : '--';
                    
                    subjectsHtml = `
                        <div class="history-subjects">
                            <div class="history-subject-item">
                                <span>Physics</span>
                                <span class="history-subject-score">${test.subjectScores.physics || 0} (‚è±Ô∏è ${physicsTime})</span>
                            </div>
                            <div class="history-subject-item">
                                <span>Maths</span>
                                <span class="history-subject-score">${test.subjectScores.maths || 0} (‚è±Ô∏è ${mathsTime})</span>
                            </div>
                            <div class="history-subject-item">
                                <span>Chemistry</span>
                                <span class="history-subject-score">${test.subjectScores.chemistry || 0} (‚è±Ô∏è ${chemistryTime})</span>
                            </div>
                        </div>
                    `;
                }
                
                historyItem.innerHTML = `
                    <div style="flex: 1;">
                        <div class="history-date">üìÖ ${dateStr}${test.testName ? ` | üìù ${test.testName}` : ''}</div>
                        <div style="display: flex; gap: 20px; margin-top: 5px; flex-wrap: wrap;">
                            <div><strong>Score:</strong> <span class="history-score">${totalScore}/${maxMarks}</span></div>
                            <div><strong>Accuracy:</strong> ${test.accuracy || 0}%</div>
                            <div><strong>Time:</strong> ${test.timeTaken || '00:00'}</div>
                        </div>
                        ${subjectsHtml}
                    </div>
                    <div class="history-actions">
                        <button class="history-action-btn history-view-btn" onclick="viewTestFromHistory(${index})">View</button>
                        <button class="history-action-btn history-compare-btn" onclick="selectForComparison(${index})">Compare</button>
                        <button class="history-action-btn history-delete-btn" onclick="deleteFromHistory(${index})">Delete</button>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
            
            document.getElementById('history-modal').style.display = 'flex';
        }
        
        // View test from history
        function viewTestFromHistory(index) {
            const test = testHistory[index];
            if (!test) return;
            
            // Populate results with test data
            document.getElementById('results-user-name').textContent = test.userName || 'Student';
            document.getElementById('results-test-name').textContent = test.testName || 'Test';
            const displayMaxMarks = test.maxMarks || (test.totalQuestions * 4) || 300;
            document.getElementById('total-score').textContent = `${test.totalScore || 0}/${displayMaxMarks}`;
            document.getElementById('total-correct').textContent = test.totalCorrect || 0;
            document.getElementById('total-incorrect').textContent = test.totalIncorrect || 0;
            document.getElementById('total-unattempted').textContent = test.totalUnattempted || 0;
            document.getElementById('total-marked').textContent = test.totalMarked || 0;
            document.getElementById('accuracy').textContent = (test.accuracy || 0) + '%';
            document.getElementById('time-taken').textContent = test.timeTaken || '00:00';
            
            // Subject wise
            if (test.subjectScores) {
                document.getElementById('physics-total').textContent = test.physicsCount || 0;
                document.getElementById('physics-score').textContent = test.subjectScores.physics || 0;
                document.getElementById('physics-correct').textContent = test.physicsCorrect || 0;
                document.getElementById('physics-incorrect').textContent = test.physicsIncorrect || 0;
                document.getElementById('physics-marked').textContent = test.physicsMarked || 0;
                document.getElementById('physics-accuracy').textContent = (test.physicsAccuracy || 0) + '%';
                
                document.getElementById('maths-total').textContent = test.mathsCount || 0;
                document.getElementById('maths-score').textContent = test.subjectScores.maths || 0;
                document.getElementById('maths-correct').textContent = test.mathsCorrect || 0;
                document.getElementById('maths-incorrect').textContent = test.mathsIncorrect || 0;
                document.getElementById('maths-marked').textContent = test.mathsMarked || 0;
                document.getElementById('maths-accuracy').textContent = (test.mathsAccuracy || 0) + '%';
                
                document.getElementById('chemistry-total').textContent = test.chemistryCount || 0;
                document.getElementById('chemistry-score').textContent = test.subjectScores.chemistry || 0;
                document.getElementById('chemistry-correct').textContent = test.chemistryCorrect || 0;
                document.getElementById('chemistry-incorrect').textContent = test.chemistryIncorrect || 0;
                document.getElementById('chemistry-marked').textContent = test.chemistryMarked || 0;
                document.getElementById('chemistry-accuracy').textContent = (test.chemistryAccuracy || 0) + '%';
            }
            
            // Populate Time Spent Analysis if data exists
            const timeSpentResults = document.getElementById('time-spent-results');
            timeSpentResults.innerHTML = '';
            
            if (test.questionTimeSpent && test.questionTimeSpent.length > 0) {
                const maxTimeSpent = Math.max(...test.questionTimeSpent);
                const totalQuestions = test.totalQuestions || test.questionTimeSpent.length;
                const physicsCount = test.physicsCount || 0;
                const mathsCount = test.mathsCount || 0;
                const chemistryCount = test.chemistryCount || 0;
                
                for (let i = 0; i < totalQuestions; i++) {
                    const row = document.createElement('tr');
                    const timeValue = test.questionTimeSpent[i] || 0;
                    const percentage = maxTimeSpent > 0 ? (timeValue / maxTimeSpent) * 100 : 0;
                    
                    let subject = '';
                    let status = 'Unattempted';
                    
                    if (i < physicsCount) {
                        subject = 'Physics';
                    } else if (i < physicsCount + mathsCount) {
                        subject = 'Mathematics';
                    } else {
                        subject = 'Chemistry';
                    }
                    
                    const minutes = Math.floor(timeValue / 60);
                    const seconds = timeValue % 60;
                    const timeFormatted = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    row.innerHTML = `
                        <td>${i + 1}</td>
                        <td>${subject}</td>
                        <td>${timeFormatted}</td>
                        <td>
                            <div class="time-bar-container">
                                <div class="time-bar" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                        <td>${status}</td>
                    `;
                    
                    timeSpentResults.appendChild(row);
                }
            }
            
            // Populate Detailed Question-wise Analysis if data exists
            const detailedResults = document.getElementById('detailed-results');
            detailedResults.innerHTML = '';
            
            if (test.physicsAnswers && test.physicsKey) {
                const physicsAnswers = test.physicsAnswers || [];
                const mathsAnswers = test.mathsAnswers || [];
                const chemistryAnswers = test.chemistryAnswers || [];
                const physicsKey = test.physicsKey || [];
                const mathsKey = test.mathsKey || [];
                const chemistryKey = test.chemistryKey || [];
                const physicsMarked = test.physicsMarkedArray || [];
                const mathsMarked = test.mathsMarkedArray || [];
                const chemistryMarked = test.chemistryMarkedArray || [];
                
                // Physics questions
                for (let i = 0; i < physicsCount; i++) {
                    const row = document.createElement('tr');
                    const userAnswer = physicsAnswers[i] || '';
                    const correctAnswer = physicsKey[i] || '';
                    let status = '';
                    let score = 0;
                    const isMarked = physicsMarked[i];
                    
                    if (userAnswer === '') {
                        status = 'Unattempted';
                        score = 0;
                    } else if (userAnswer === correctAnswer) {
                        status = 'Correct';
                        score = 4;
                    } else {
                        status = 'Incorrect';
                        score = -1;
                    }
                    
                    row.innerHTML = `
                        <td>Physics</td>
                        <td>${i + 1}</td>
                        <td>${userAnswer || '-'}</td>
                        <td>${correctAnswer}</td>
                        <td class="${status === 'Correct' ? 'success' : status === 'Incorrect' ? 'highlight' : ''}">${status}</td>
                        <td class="${score > 0 ? 'success' : score < 0 ? 'highlight' : ''}">${score > 0 ? '+' : ''}${score}</td>
                        <td class="${isMarked ? 'warning' : ''}">${isMarked ? 'Yes' : 'No'}</td>
                    `;
                    
                    detailedResults.appendChild(row);
                }
                
                // Maths questions
                for (let i = 0; i < mathsCount; i++) {
                    const row = document.createElement('tr');
                    const userAnswer = mathsAnswers[i] || '';
                    const correctAnswer = mathsKey[i] || '';
                    let status = '';
                    let score = 0;
                    const isMarked = mathsMarked[i];
                    
                    if (userAnswer === '') {
                        status = 'Unattempted';
                        score = 0;
                    } else if (userAnswer === correctAnswer) {
                        status = 'Correct';
                        score = 4;
                    } else {
                        status = 'Incorrect';
                        score = -1;
                    }
                    
                    row.innerHTML = `
                        <td>Mathematics</td>
                        <td>${i + 1}</td>
                        <td>${userAnswer || '-'}</td>
                        <td>${correctAnswer}</td>
                        <td class="${status === 'Correct' ? 'success' : status === 'Incorrect' ? 'highlight' : ''}">${status}</td>
                        <td class="${score > 0 ? 'success' : score < 0 ? 'highlight' : ''}">${score > 0 ? '+' : ''}${score}</td>
                        <td class="${isMarked ? 'warning' : ''}">${isMarked ? 'Yes' : 'No'}</td>
                    `;
                    
                    detailedResults.appendChild(row);
                }
                
                // Chemistry questions
                for (let i = 0; i < chemistryCount; i++) {
                    const row = document.createElement('tr');
                    const userAnswer = chemistryAnswers[i] || '';
                    const correctAnswer = chemistryKey[i] || '';
                    let status = '';
                    let score = 0;
                    const isMarked = chemistryMarked[i];
                    
                    if (userAnswer === '') {
                        status = 'Unattempted';
                        score = 0;
                    } else if (userAnswer === correctAnswer) {
                        status = 'Correct';
                        score = 4;
                    } else {
                        status = 'Incorrect';
                        score = -1;
                    }
                    
                    row.innerHTML = `
                        <td>Chemistry</td>
                        <td>${i + 1}</td>
                        <td>${userAnswer || '-'}</td>
                        <td>${correctAnswer}</td>
                        <td class="${status === 'Correct' ? 'success' : status === 'Incorrect' ? 'highlight' : ''}">${status}</td>
                        <td class="${score > 0 ? 'success' : score < 0 ? 'highlight' : ''}">${score > 0 ? '+' : ''}${score}</td>
                        <td class="${isMarked ? 'warning' : ''}">${isMarked ? 'Yes' : 'No'}</td>
                    `;
                    
                    detailedResults.appendChild(row);
                }
            }
            
            // Hide history modal and show results
            document.getElementById('history-modal').style.display = 'none';
            document.getElementById('results-modal').style.display = 'flex';
        }
        
        // Variables for comparison
        let comparisonTests = [];
        
        // Select test for comparison
        function selectForComparison(index) {
            const test = testHistory[index];
            if (!test) return;
            
            if (comparisonTests.length >= 2) {
                alert('You can only compare two tests at a time. Please clear selection first.');
                return;
            }
            
            comparisonTests.push(test);
            
            // Highlight selected test
            const items = document.querySelectorAll('.history-item');
            items.forEach(item => {
                if (parseInt(item.getAttribute('data-index')) === index) {
                    item.classList.add('selected');
                }
            });
            
            if (comparisonTests.length === 2) {
                showComparison();
            }
        }
        
        // Show comparison of two tests
        function showComparison() {
            if (comparisonTests.length !== 2) return;
            
            const test1 = comparisonTests[0];
            const test2 = comparisonTests[1];
            
            const comparisonContent = document.getElementById('comparison-content');
            comparisonContent.innerHTML = `
                <div class="comparison-card">
                    <h4>Test 1 - ${formatDate(test1.date)}</h4>
                    <div class="comparison-stat">
                        <span class="comparison-label">Total Score:</span>
                        <span class="comparison-value ${test1.totalScore > test2.totalScore ? 'winner-badge' : ''}">${test1.totalScore || 0}</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Physics:</span>
                        <span class="comparison-value ${(test1.subjectScores?.physics || 0) > (test2.subjectScores?.physics || 0) ? 'winner-badge' : ''}">${test1.subjectScores?.physics || 0}</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Mathematics:</span>
                        <span class="comparison-value ${(test1.subjectScores?.maths || 0) > (test2.subjectScores?.maths || 0) ? 'winner-badge' : ''}">${test1.subjectScores?.maths || 0}</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Chemistry:</span>
                        <span class="comparison-value ${(test1.subjectScores?.chemistry || 0) > (test2.subjectScores?.chemistry || 0) ? 'winner-badge' : ''}">${test1.subjectScores?.chemistry || 0}</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Accuracy:</span>
                        <span class="comparison-value ${(test1.accuracy || 0) > (test2.accuracy || 0) ? 'winner-badge' : ''}">${test1.accuracy || 0}%</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Time Taken:</span>
                        <span class="comparison-value">${test1.timeTaken || '00:00'}</span>
                    </div>
                </div>
                <div class="comparison-card">
                    <h4>Test 2 - ${formatDate(test2.date)}</h4>
                    <div class="comparison-stat">
                        <span class="comparison-label">Total Score:</span>
                        <span class="comparison-value ${test2.totalScore > test1.totalScore ? 'winner-badge' : ''}">${test2.totalScore || 0}</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Physics:</span>
                        <span class="comparison-value ${(test2.subjectScores?.physics || 0) > (test1.subjectScores?.physics || 0) ? 'winner-badge' : ''}">${test2.subjectScores?.physics || 0}</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Mathematics:</span>
                        <span class="comparison-value ${(test2.subjectScores?.maths || 0) > (test1.subjectScores?.maths || 0) ? 'winner-badge' : ''}">${test2.subjectScores?.maths || 0}</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Chemistry:</span>
                        <span class="comparison-value ${(test2.subjectScores?.chemistry || 0) > (test1.subjectScores?.chemistry || 0) ? 'winner-badge' : ''}">${test2.subjectScores?.chemistry || 0}</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Accuracy:</span>
                        <span class="comparison-value ${(test2.accuracy || 0) > (test1.accuracy || 0) ? 'winner-badge' : ''}">${test2.accuracy || 0}%</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-label">Time Taken:</span>
                        <span class="comparison-value">${test2.timeTaken || '00:00'}</span>
                    </div>
                </div>
            `;
            
            // Show comparison modal
            document.getElementById('comparison-modal').style.display = 'flex';
            
            // Clear selection
            document.querySelectorAll('.history-item').forEach(item => {
                item.classList.remove('selected');
            });
            comparisonTests = [];
        }
        
        // Delete test from history
        function deleteFromHistory(index) {
            if (confirm('Are you sure you want to delete this test from history?')) {
                testHistory.splice(index, 1);
                saveTestHistory();
                showTestHistory(); // Refresh the history list
            }
        }
        
        // Clear all history
        function clearAllHistory() {
            if (confirm('Are you sure you want to delete ALL test history? This cannot be undone!')) {
                testHistory = [];
                saveTestHistory();
                showTestHistory();
            }
        }
        
        // Setup all event listeners
        function setupEventListeners() {
            // Test type toggle
            document.getElementById('test-type').addEventListener('change', function() {
                const customConfig = document.getElementById('custom-test-config');
                if (this.value === 'custom') {
                    customConfig.style.display = 'block';
                } else {
                    customConfig.style.display = 'none';
                }
            });
            
            // Start test button
            document.getElementById('start-test-btn').addEventListener('click', startTest);
            
            // Image navigation
            document.getElementById('prev-image-btn').addEventListener('click', prevImage);
            document.getElementById('next-image-btn').addEventListener('click', nextImage);
            
            // Option selection
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    selectOption(this.getAttribute('data-option'));
                });
            });
            
            // Navigation buttons
            document.getElementById('prev-btn').addEventListener('click', prevQuestion);
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
            document.getElementById('mark-review-btn').addEventListener('click', markForReview);
            document.getElementById('submit-btn').addEventListener('click', submitTest);
            
            // Subject tabs
            document.querySelectorAll('.subject-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchSubject(this.getAttribute('data-subject'));
                });
            });
            
            // Answer input tracking
            document.getElementById('physics-answers-input').addEventListener('input', function() {
                document.getElementById('physics-answers-length').textContent = this.value.length;
                this.value = this.value.toUpperCase().replace(/[^ABCD]/g, '');
            });
            
            document.getElementById('maths-answers-input').addEventListener('input', function() {
                document.getElementById('maths-answers-length').textContent = this.value.length;
                this.value = this.value.toUpperCase().replace(/[^ABCD]/g, '');
            });
            
            document.getElementById('chemistry-answers-input').addEventListener('input', function() {
                document.getElementById('chemistry-answers-length').textContent = this.value.length;
                this.value = this.value.toUpperCase().replace(/[^ABCD]/g, '');
            });
            
            // Modal buttons
            document.getElementById('cancel-submit-btn').addEventListener('click', cancelSubmit);
            document.getElementById('calculate-results-btn').addEventListener('click', calculateResults);
            document.getElementById('close-results-btn').addEventListener('click', closeResults);
            document.getElementById('new-test-btn').addEventListener('click', startNewTest);
            document.getElementById('view-results-btn').addEventListener('click', viewResultsAgain);
            document.getElementById('final-new-test-btn').addEventListener('click', startNewTest);
            
            // History buttons
            document.getElementById('view-history-btn').addEventListener('click', showTestHistory);
            document.getElementById('close-history-btn').addEventListener('click', function() {
                document.getElementById('history-modal').style.display = 'none';
            });
            document.getElementById('clear-history-btn').addEventListener('click', clearAllHistory);
            document.getElementById('close-comparison-btn').addEventListener('click', function() {
                document.getElementById('comparison-modal').style.display = 'none';
            });
            
            // Multiple file selection for images (Question Images)
            document.getElementById('physics-images').addEventListener('change', function(e) {
                loadMultipleImages(e.target.files, 'physics', 25);
            });
            
            document.getElementById('maths-images').addEventListener('change', function(e) {
                loadMultipleImages(e.target.files, 'maths', 25);
            });
            
            document.getElementById('chemistry-images').addEventListener('change', function(e) {
                loadMultipleImages(e.target.files, 'chemistry', 25);
            });
            
            // Multiple file selection for answer images (Max 3 each)
            document.getElementById('physics-answers').addEventListener('change', function(e) {
                loadAnswerImages(e.target.files, 'physics', 3);
            });
            
            document.getElementById('maths-answers').addEventListener('change', function(e) {
                loadAnswerImages(e.target.files, 'maths', 3);
            });
            
            document.getElementById('chemistry-answers').addEventListener('change', function(e) {
                loadAnswerImages(e.target.files, 'chemistry', 3);
            });
            
            // Txt answer file inputs
            document.getElementById('physics-answers-txt').addEventListener('change', function(e) {
                loadAnswerTxtFiles(e.target.files, 'physics');
            });
            document.getElementById('maths-answers-txt').addEventListener('change', function(e) {
                loadAnswerTxtFiles(e.target.files, 'maths');
            });
            document.getElementById('chemistry-answers-txt').addEventListener('change', function(e) {
                loadAnswerTxtFiles(e.target.files, 'chemistry');
            });
            
            // Txt drop zones click handlers (reset value so multi-select always works)
            document.getElementById('physics-txt-drop-zone').addEventListener('click', function() {
                const inp = document.getElementById('physics-answers-txt');
                inp.value = '';
                inp.click();
            });
            document.getElementById('maths-txt-drop-zone').addEventListener('click', function() {
                const inp = document.getElementById('maths-answers-txt');
                inp.value = '';
                inp.click();
            });
            document.getElementById('chemistry-txt-drop-zone').addEventListener('click', function() {
                const inp = document.getElementById('chemistry-answers-txt');
                inp.value = '';
                inp.click();
            });
            
            // Auto-advance toggle
            document.getElementById('auto-advance-toggle').addEventListener('change', function() {
                autoAdvanceImage = this.checked;
            });
            
            // Setup drag-drop zones and click handlers
            setupDropZone('physics-drop-zone', 'physics-images', 'physics', 25, false);
            setupDropZone('maths-drop-zone', 'maths-images', 'maths', 25, false);
            setupDropZone('chemistry-drop-zone', 'chemistry-images', 'chemistry', 25, false);
            setupDropZone('physics-ans-drop-zone', 'physics-answers', 'physics', 3, true);
            setupDropZone('maths-ans-drop-zone', 'maths-answers', 'maths', 3, true);
            setupDropZone('chemistry-ans-drop-zone', 'chemistry-answers', 'chemistry', 3, true);
        }
        
        // Setup drag-drop zone functionality
        function setupDropZone(dropZoneId, inputId, subject, maxLimit, isAnswer) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(inputId);
            
            // Click to open file dialog
            dropZone.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Drag over
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#2196f3';
                this.style.background = '#e3f2fd';
            });
            
            // Drag leave
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = isAnswer ? '#ff9800' : '#3f51b5';
                this.style.background = isAnswer ? '#fff3e0' : '#f5f5f5';
            });
            
            // Drop
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = isAnswer ? '#ff9800' : '#3f51b5';
                this.style.background = isAnswer ? '#fff3e0' : '#f5f5f5';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (isAnswer) {
                        loadAnswerImages(files, subject, maxLimit);
                    } else {
                        loadMultipleImages(files, subject, maxLimit);
                    }
                }
            });
        }
        
        // Load multiple question images with limit
        function loadMultipleImages(files, subject, maxLimit) {
            console.log(`=== Loading ${subject} images ===`);
            console.log(`Total files received:`, files.length);
            console.log(`Files:`, files);
            
            const imageFiles = Array.from(files).filter(file => {
                const isImage = file.type.startsWith('image/');
                console.log(`File: ${file.name}, Type: ${file.type}, Is Image: ${isImage}`);
                return isImage;
            }); // Keep selection order - do NOT sort
            
            console.log(`Image files after filtering:`, imageFiles.length);
            
            if (imageFiles.length === 0) {
                alert('No image files found in the selection!');
                return;
            }
            
            // Get existing images for this subject
            let existingImages = [];
            if (subject === 'physics') {
                existingImages = loadedPhysicsImages;
            } else if (subject === 'maths') {
                existingImages = loadedMathsImages;
            } else if (subject === 'chemistry') {
                existingImages = loadedChemistryImages;
            }
            
            // Check if adding these would exceed limit
            const totalAfterAdding = existingImages.length + imageFiles.length;
            if (totalAfterAdding > maxLimit) {
                const remaining = maxLimit - existingImages.length;
                if (remaining <= 0) {
                    alert(`‚ö†Ô∏è Maximum limit (${maxLimit}) already reached! Cannot add more images.`);
                    return;
                }
                alert(`‚ö†Ô∏è You selected ${imageFiles.length} images, but only ${remaining} more can be added (limit: ${maxLimit}).\nOnly the first ${remaining} images will be loaded.`);
            }
            
            // Calculate how many we can actually add
            const availableSlots = maxLimit - existingImages.length;
            const limitedFiles = imageFiles.slice(0, availableSlots);
            console.log(`Loading ${limitedFiles.length} images (${existingImages.length} already loaded)`);
            
            // Store the loaded images with their data URLs
            const imagePromises = limitedFiles.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve({
                            name: file.name,
                            dataURL: e.target.result,
                            size: file.size
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });
            
            Promise.all(imagePromises).then(newImages => {
                console.log(`‚úì Successfully loaded ${newImages.length} new images`);
                
                // APPEND new images to existing ones
                const allImages = [...existingImages, ...newImages];
                
                if (subject === 'physics') {
                    loadedPhysicsImages = allImages;
                    document.getElementById('physics-count-info').textContent = `‚úì ${allImages.length} images selected`;
                    document.getElementById('physics-count-info').style.color = '#2e7d32';
                    document.getElementById('physics-count-info').style.fontWeight = 'bold';
                } else if (subject === 'maths') {
                    loadedMathsImages = allImages;
                    document.getElementById('maths-count-info').textContent = `‚úì ${allImages.length} images selected`;
                    document.getElementById('maths-count-info').style.color = '#2e7d32';
                    document.getElementById('maths-count-info').style.fontWeight = 'bold';
                } else if (subject === 'chemistry') {
                    loadedChemistryImages = allImages;
                    document.getElementById('chemistry-count-info').textContent = `‚úì ${allImages.length} images selected`;
                    document.getElementById('chemistry-count-info').style.color = '#2e7d32';
                    document.getElementById('chemistry-count-info').style.fontWeight = 'bold';
                }
                
                console.log(`‚úì Total ${subject} images now: ${allImages.length}`, allImages.map(img => img.name));
            }).catch(error => {
                console.error('Error loading images:', error);
                alert('Error loading images. Please try again.');
            });
        }
        
        // Load answer key images with limit
        function loadAnswerImages(files, subject, maxLimit) {
            const imageFiles = Array.from(files).filter(file => {
                return file.type.startsWith('image/');
            }); // Keep selection order - do NOT sort
            
            if (imageFiles.length === 0) {
                alert('No image files found in the selection!');
                return;
            }
            
            // Get existing answer images
            let existingImages = [];
            if (subject === 'physics') {
                existingImages = loadedPhysicsAnswers;
            } else if (subject === 'maths') {
                existingImages = loadedMathsAnswers;
            } else if (subject === 'chemistry') {
                existingImages = loadedChemistryAnswers;
            }
            
            // Check if adding these would exceed limit
            const totalAfterAdding = existingImages.length + imageFiles.length;
            if (totalAfterAdding > maxLimit) {
                const remaining = maxLimit - existingImages.length;
                if (remaining <= 0) {
                    alert(`‚ö†Ô∏è Maximum limit (${maxLimit}) already reached for answer images! Cannot add more.`);
                    return;
                }
                alert(`‚ö†Ô∏è You selected ${imageFiles.length} answer images, but only ${remaining} more can be added (limit: ${maxLimit}).\nOnly the first ${remaining} images will be loaded.`);
            }
            
            // Take only up to available slots
            const availableSlots = maxLimit - existingImages.length;
            const limitedFiles = imageFiles.slice(0, availableSlots);
            
            // Store the loaded images with their data URLs
            const imagePromises = limitedFiles.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve({
                            name: file.name,
                            dataURL: e.target.result,
                            size: file.size
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });
            
            Promise.all(imagePromises).then(newImages => {
                // APPEND new images to existing ones
                const allImages = [...existingImages, ...newImages];
                
                if (subject === 'physics') {
                    loadedPhysicsAnswers = allImages;
                    document.getElementById('physics-ans-info').textContent = `‚úì ${allImages.length} answer images selected`;
                    document.getElementById('physics-ans-info').style.color = '#2e7d32';
                    document.getElementById('physics-ans-info').style.fontWeight = 'bold';
                } else if (subject === 'maths') {
                    loadedMathsAnswers = allImages;
                    document.getElementById('maths-ans-info').textContent = `‚úì ${allImages.length} answer images selected`;
                    document.getElementById('maths-ans-info').style.color = '#2e7d32';
                    document.getElementById('maths-ans-info').style.fontWeight = 'bold';
                } else if (subject === 'chemistry') {
                    loadedChemistryAnswers = allImages;
                    document.getElementById('chemistry-ans-info').textContent = `‚úì ${allImages.length} answer images selected`;
                    document.getElementById('chemistry-ans-info').style.color = '#2e7d32';
                    document.getElementById('chemistry-ans-info').style.fontWeight = 'bold';
                }
                
                console.log(`‚úì Total ${subject} answer images now: ${allImages.length}`, allImages.map(img => img.name));
            }).catch(error => {
                console.error('Error loading answer images:', error);
                alert('Error loading answer images. Please try again.');
            });
        }
        
        // Show per-file range inputs after files are selected
        function showTxtRangeInputs(files, subject) {
            const container = document.getElementById(subject + '-txt-ranges');
            container.innerHTML = '';
            container.style.display = 'block';
            
            files.forEach((file, i) => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; align-items:center; gap:7px; flex-wrap:wrap; margin-bottom:5px; padding:6px 8px; background:#f1f8e9; border-radius:5px; border:1px solid #c8e6c9;';
                row.innerHTML = `
                    <span style="font-size:12px; color:#2e7d32; font-weight:bold; flex:1; min-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${file.name}">üìÑ ${file.name}</span>
                    <span style="font-size:12px; color:#555;">From:</span>
                    <input type="number" id="${subject}-txt-from-${i}" placeholder="1" min="1" style="width:70px; padding:2px 5px; border:1px solid #a5d6a7; border-radius:4px; font-size:12px;">
                    <span style="font-size:12px; color:#555;">To:</span>
                    <input type="number" id="${subject}-txt-to-${i}" placeholder="all" min="1" style="width:70px; padding:2px 5px; border:1px solid #a5d6a7; border-radius:4px; font-size:12px;">
                    <span style="font-size:11px; color:#999;">(blank=all)</span>
                `;
                container.appendChild(row);
            });

            // Add Apply button
            const applyBtn = document.createElement('button');
            applyBtn.textContent = '‚úÖ Apply Ranges & Load';
            applyBtn.style.cssText = 'margin-top:4px; padding:5px 14px; background:#4caf50; color:white; border:none; border-radius:5px; font-size:13px; cursor:pointer; font-weight:bold;';
            applyBtn.onclick = () => applyTxtRangesAndLoad(subject);
            container.appendChild(applyBtn);
        }

        // Apply per-file ranges and load answer key
        function applyTxtRangesAndLoad(subject) {
            const stored = window['_txtFiles_' + subject];
            if (!stored || stored.length === 0) return;

            const promises = stored.map((file, i) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve({ content: e.target.result.trim(), index: i });
                reader.onerror = reject;
                reader.readAsText(file);
            }));

            Promise.all(promises).then(results => {
                let combined = '';
                let rangeDetails = [];

                results.forEach(({ content, index: i }) => {
                    const filtered = content.toUpperCase().replace(/[^ABCD]/g, '').substring(0, 100);
                    const fromEl = document.getElementById(subject + '-txt-from-' + i);
                    const toEl = document.getElementById(subject + '-txt-to-' + i);
                    const fromVal = fromEl ? parseInt(fromEl.value) : NaN;
                    const toVal = toEl ? parseInt(toEl.value) : NaN;

                    const startIdx = (!isNaN(fromVal) && fromVal >= 1) ? fromVal - 1 : 0;
                    const endIdx = (!isNaN(toVal) && toVal >= 1) ? toVal : filtered.length;
                    const slice = filtered.substring(startIdx, endIdx);
                    combined += slice;

                    const label = (isNaN(fromVal) && isNaN(toVal)) ? 'all' : `${startIdx+1}‚Äì${startIdx + slice.length}`;
                    rangeDetails.push(`File${i+1}(${label}:${slice.length}ans)`);
                });

                const infoEl = document.getElementById(subject + '-txt-info');
                infoEl.textContent = `‚úì ${stored.length} file(s) ‚Üí ${combined.length} answers total | ${rangeDetails.join(' + ')}`;
                infoEl.style.color = '#2e7d32';
                infoEl.style.fontWeight = 'bold';

                if (subject === 'physics') physicsTxtAnswerKey = combined;
                else if (subject === 'maths') mathsTxtAnswerKey = combined;
                else if (subject === 'chemistry') chemistryTxtAnswerKey = combined;

                console.log(`‚úì ${subject} txt answer key loaded: ${combined}`);
            }).catch(err => {
                console.error('Error reading txt files:', err);
                alert('Error reading txt files. Please try again.');
            });
        }

        // Load answer key from txt files (max 3, max 100 answers each)
        function loadAnswerTxtFiles(files, subject) {
            const txtFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.txt'));
            if (txtFiles.length === 0) {
                alert('Please select .txt files only!');
                return;
            }
            if (txtFiles.length > 3) {
                alert('Maximum 3 txt files allowed! Only first 3 will be used.');
                txtFiles.splice(3);
            }

            // Store files for later use when Apply is clicked
            window['_txtFiles_' + subject] = txtFiles;

            // Show per-file range inputs
            showTxtRangeInputs(txtFiles, subject);

            const infoEl = document.getElementById(subject + '-txt-info');
            infoEl.textContent = `${txtFiles.length} file(s) selected ‚Äî set ranges above then click Apply`;
            infoEl.style.color = '#f57c00';
            infoEl.style.fontWeight = 'bold';
        }
        
        // Detect available images from folders - Uses loaded images from File API
        function detectAvailableImages() {
            // If images are loaded from folders, use them
            if (loadedPhysicsImages.length > 0) {
                physicsImages = loadedPhysicsImages.map((img, index) => ({
                    id: index + 1,
                    questions: 1, // 1 question per image
                    path: img.dataURL,
                    name: img.name
                }));
            } else {
                // Fallback: Try to load from default paths with flexible naming
                physicsImages = [];
                for (let i = 1; i <= 25; i++) {
                    physicsImages.push({
                        id: i,
                        questions: i === 3 ? 5 : 10,
                        path: `images/physics/q${i}.jpg`
                    });
                }
            }
            
            if (loadedMathsImages.length > 0) {
                mathsImages = loadedMathsImages.map((img, index) => ({
                    id: index + 1,
                    questions: 1,
                    path: img.dataURL,
                    name: img.name
                }));
            } else {
                mathsImages = [];
                for (let i = 1; i <= 25; i++) {
                    mathsImages.push({
                        id: i,
                        questions: i === 3 ? 5 : 10,
                        path: `images/maths/q${i}.jpg`
                    });
                }
            }
            
            if (loadedChemistryImages.length > 0) {
                chemistryImages = loadedChemistryImages.map((img, index) => ({
                    id: index + 1,
                    questions: 1,
                    path: img.dataURL,
                    name: img.name
                }));
            } else {
                chemistryImages = [];
                for (let i = 1; i <= 25; i++) {
                    chemistryImages.push({
                        id: i,
                        questions: i === 3 ? 5 : 10,
                        path: `images/chemistry/q${i}.jpg`
                    });
                }
            }
            
            // Answer key images - Use loaded answer images if available
            if (loadedPhysicsAnswers.length > 0) {
                physicsAnswerImages = loadedPhysicsAnswers.map((img, index) => ({
                    id: index + 1,
                    path: img.dataURL,
                    name: img.name
                }));
            } else {
                physicsAnswerImages = [];
                for (let i = 1; i <= 3; i++) {
                    physicsAnswerImages.push({
                        id: i,
                        path: `images/answer/physics/a${i}.jpg`
                    });
                }
            }
            
            if (loadedMathsAnswers.length > 0) {
                mathsAnswerImages = loadedMathsAnswers.map((img, index) => ({
                    id: index + 1,
                    path: img.dataURL,
                    name: img.name
                }));
            } else {
                mathsAnswerImages = [];
                for (let i = 1; i <= 3; i++) {
                    mathsAnswerImages.push({
                        id: i,
                        path: `images/answer/maths/a${i}.jpg`
                    });
                }
            }
            
            if (loadedChemistryAnswers.length > 0) {
                chemistryAnswerImages = loadedChemistryAnswers.map((img, index) => ({
                    id: index + 1,
                    path: img.dataURL,
                    name: img.name
                }));
            } else {
                chemistryAnswerImages = [];
                for (let i = 1; i <= 3; i++) {
                    chemistryAnswerImages.push({
                        id: i,
                        path: `images/answer/chemistry/a${i}.jpg`
                    });
                }
            }
            
            const loadSource = loadedPhysicsImages.length > 0 || loadedMathsImages.length > 0 || loadedChemistryImages.length > 0 ? 'from selected files' : 'from default paths';
            console.log(`Images detected ${loadSource}: Physics=${physicsImages.length}, Maths=${mathsImages.length}, Chemistry=${chemistryImages.length}`);
            console.log(`Answer images: Physics=${physicsAnswerImages.length}, Maths=${mathsAnswerImages.length}, Chemistry=${chemistryAnswerImages.length}`);
        }
        
        // Start the test
        function startTest() {
            // Get user inputs
            userName = document.getElementById('user-name').value.trim();
            testName = document.getElementById('test-name').value.trim() || 'Test';
            if (userName === "") {
                alert("Please enter your name");
                return;
            }
            
            // Re-detect images to include any newly loaded folder images
            detectAvailableImages();
            
            // Check if images are loaded
            const hasPhysicsImages = loadedPhysicsImages.length > 0 || physicsImages.length > 0;
            const hasMathsImages = loadedMathsImages.length > 0 || mathsImages.length > 0;
            const hasChemistryImages = loadedChemistryImages.length > 0 || chemistryImages.length > 0;
            
            if (!hasPhysicsImages && !hasMathsImages && !hasChemistryImages) {
                alert("‚ö†Ô∏è No images loaded!\n\nPlease select image folders using the buttons above, or make sure images are placed in the default folders:\n- images/physics/\n- images/maths/\n- images/chemistry/");
                return;
            }
            
            testType = document.getElementById('test-type').value;
            
            if (testType === "full") {
                physicsCount = 25;
                mathsCount = 25;
                chemistryCount = 25;
                totalQuestions = 75;
                customTime = 180;
            } else {
                physicsCount = parseInt(document.getElementById('physics-count').value) || 0;
                mathsCount = parseInt(document.getElementById('maths-count').value) || 0;
                chemistryCount = parseInt(document.getElementById('chemistry-count').value) || 0;
                customTime = parseInt(document.getElementById('test-time').value) || 180;
                
                totalQuestions = physicsCount + mathsCount + chemistryCount;
                if (totalQuestions === 0) {
                    alert("Please select at least one question");
                    return;
                }
            }
            
            // Set timer
            totalSeconds = customTime * 60;
            
            // Set initial timer display in MM:SS format
            document.getElementById('timer').textContent = `${customTime}:00`;
            
            // Initialize arrays
            physicsAnswers = new Array(physicsCount).fill('');
            mathsAnswers = new Array(mathsCount).fill('');
            chemistryAnswers = new Array(chemistryCount).fill('');
            
            physicsMarked = new Array(physicsCount).fill(false);
            mathsMarked = new Array(mathsCount).fill(false);
            chemistryMarked = new Array(chemistryCount).fill(false);
            
            timeSpent = new Array(totalQuestions).fill(0);
            
            // Initialize subject memory
            subjectMemory = {
                physics: { lastQuestion: 1, lastImageIndex: 0 },
                maths: { lastQuestion: null, lastImageIndex: 0 },
                chemistry: { lastQuestion: null, lastImageIndex: 0 }
            };
            
            // Update UI with configuration
            document.getElementById('display-user-name').textContent = userName;
            document.getElementById('display-user-name-instructions').textContent = userName;
            document.getElementById('results-user-name').textContent = userName;
            document.getElementById('results-test-name').textContent = testName;
            
            const timeText = customTime >= 60 ? 
                `${Math.floor(customTime/60)} hour${customTime >= 120 ? 's' : ''} ${customTime%60} min` : 
                `${customTime} minutes`;
            
            document.getElementById('test-config-summary').textContent = 
                `${testType === 'full' ? 'Full Mock Test' : 'Custom Test'} | ${totalQuestions} Questions | ${timeText}`;
            document.getElementById('test-config-summary-instructions').textContent = 
                `${testType === 'full' ? 'Full Mock Test' : 'Custom Test'} | ${totalQuestions} Questions | ${timeText}`;
            
            document.getElementById('test-stats').textContent = 
                `Physics: ${physicsCount} | Maths: ${mathsCount} | Chemistry: ${chemistryCount}`;
            document.getElementById('test-stats-instructions').textContent = 
                `Physics: ${physicsCount} | Maths: ${mathsCount} | Chemistry: ${chemistryCount}`;
            
            document.getElementById('total-time-minutes').textContent = customTime;
            
            // Update subject ranges
            document.getElementById('physics-max').textContent = physicsCount;
            document.getElementById('maths-start').textContent = physicsCount + 1;
            document.getElementById('maths-max').textContent = physicsCount + mathsCount;
            document.getElementById('chemistry-start').textContent = physicsCount + mathsCount + 1;
            document.getElementById('chemistry-max').textContent = totalQuestions;
            
            // Update palette ranges
            document.getElementById('palette-physics-max').textContent = physicsCount;
            document.getElementById('palette-maths-start').textContent = physicsCount + 1;
            document.getElementById('palette-maths-max').textContent = physicsCount + mathsCount;
            document.getElementById('palette-chemistry-start').textContent = physicsCount + mathsCount + 1;
            document.getElementById('palette-chemistry-max').textContent = totalQuestions;
            
            // Update answer key counts
            document.getElementById('physics-key-count').textContent = physicsCount;
            document.getElementById('maths-key-count').textContent = mathsCount;
            document.getElementById('chemistry-key-count').textContent = chemistryCount;
            
            // Set answer input max lengths
            document.getElementById('physics-answers-input').maxLength = physicsCount;
            document.getElementById('maths-answers-input').maxLength = mathsCount;
            document.getElementById('chemistry-answers-input').maxLength = chemistryCount;
            
            // Update placeholder text
            document.getElementById('physics-answers-input').placeholder = 'A'.repeat(physicsCount);
            document.getElementById('maths-answers-input').placeholder = 'A'.repeat(mathsCount);
            document.getElementById('chemistry-answers-input').placeholder = 'A'.repeat(chemistryCount);
            
            // Initialize question palette
            initQuestionPalette();
            
            // Hide login, show test
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('test-container').style.display = 'block';
            
            // Load first question
            loadQuestion(currentQuestion);
            
            // Start timer
            startTimer();
            testStarted = true;
        }
        
        // Initialize question palette buttons
        function initQuestionPalette() {
            // Clear existing palette buttons
            document.getElementById('physics-palette').innerHTML = '';
            document.getElementById('maths-palette').innerHTML = '';
            document.getElementById('chemistry-palette').innerHTML = '';
            
            // Physics palette
            const physicsPalette = document.getElementById('physics-palette');
            for (let i = 1; i <= physicsCount; i++) {
                const btn = createPaletteButton(i, 'physics');
                physicsPalette.appendChild(btn);
            }
            
            // Maths palette
            const mathsPalette = document.getElementById('maths-palette');
            for (let i = 1; i <= mathsCount; i++) {
                const btn = createPaletteButton(i + physicsCount, 'maths');
                mathsPalette.appendChild(btn);
            }
            
            // Chemistry palette
            const chemistryPalette = document.getElementById('chemistry-palette');
            for (let i = 1; i <= chemistryCount; i++) {
                const btn = createPaletteButton(i + physicsCount + mathsCount, 'chemistry');
                chemistryPalette.appendChild(btn);
            }
        }
        
        // Create palette button
        function createPaletteButton(questionNumber, subject) {
            const btn = document.createElement('button');
            btn.className = 'palette-btn not-visited';
            btn.textContent = questionNumber;
            btn.setAttribute('data-question', questionNumber);
            btn.setAttribute('data-subject', subject);
            btn.addEventListener('click', function() {
                navigateToQuestion(parseInt(this.getAttribute('data-question')));
            });
            return btn;
        }
        
        // Load a specific question
        function loadQuestion(questionNumber) {
            // Record time spent on previous question
            if (testStarted && !testSubmitted) {
                const now = new Date();
                const timeElapsed = Math.floor((now - questionStartTime) / 1000);
                timeSpent[currentQuestion - 1] += timeElapsed;
                questionStartTime = now;
            }
            
            // Store previous subject to detect subject change
            const previousSubject = currentSubject;
            
            // Update current question
            currentQuestion = questionNumber;
            
            // Determine subject based on question number
            if (questionNumber <= physicsCount) {
                currentSubject = 'physics';
            } else if (questionNumber <= physicsCount + mathsCount) {
                currentSubject = 'maths';
            } else {
                currentSubject = 'chemistry';
            }
            
            // Update subject tabs
            updateSubjectTabs();
            
            // Calculate question number within subject (1-25)
            const subjectQuestionNumber = getSubjectQuestionNumber(questionNumber);
            
            // Only recalculate image index if:
            // 1. NOT switching subjects via tabs (preserve restored image), AND
            // 2. Either subject changed OR user did not manually change image OR auto-advance is ON
            if (!isSubjectSwitching) {
                // When auto-advance is ON, always recalculate image from question
                // When OFF, only recalculate if subject changed or no manual override
                if (autoAdvanceImage || previousSubject !== currentSubject || !manualImageChange) {
                    let imageInfo = getImageForQuestion(currentSubject, subjectQuestionNumber);
                    currentImageIndex = imageInfo.imageIndex;
                }
            }
            
            // Reset manualImageChange after each question navigation
            // (manual override only lasts for ONE question, then resets)
            if (!autoAdvanceImage) {
                manualImageChange = false;
            }
            // If isSubjectSwitching is true, currentImageIndex is already set by switchSubject()
            
            // Reset the subject switching flag
            isSubjectSwitching = false;
            
            // Update image navigation
            updateImageNavigation();
            
            // Load current image
            loadCurrentImage();
            
            // Update question number display
            const subjectName = currentSubject.charAt(0).toUpperCase() + currentSubject.slice(1);
            document.getElementById('question-number').textContent = 
                `Question ${questionNumber} of ${totalQuestions} (${subjectName} Q${subjectQuestionNumber})`;
            
            // Update current question badge in right panel
            document.getElementById('current-q-number').textContent = questionNumber;
            
            // Load saved answer for this question
            loadAnswerForQuestion();
            
            // Update palette to highlight current question
            updatePalette();
            
            // Update mark for review button
            updateMarkForReviewButton();
            
            // Save current state to subject memory
            subjectMemory[currentSubject].lastQuestion = currentQuestion;
            subjectMemory[currentSubject].lastImageIndex = currentImageIndex;
        }
        
        // Get which image a question belongs to
        function getImageForQuestion(subject, questionNumber) {
            let images = [];
            if (subject === 'physics') images = physicsImages;
            else if (subject === 'maths') images = mathsImages;
            else images = chemistryImages;
            
            if (!images || images.length === 0) {
                return { imageIndex: 0, image: null, questionInImage: 0 };
            }
            
            let cumulativeQuestions = 0;
            for (let i = 0; i < images.length; i++) {
                cumulativeQuestions += images[i].questions;
                if (questionNumber <= cumulativeQuestions) {
                    return {
                        imageIndex: i,
                        image: images[i],
                        questionInImage: questionNumber - (cumulativeQuestions - images[i].questions) - 1
                    };
                }
            }
            
            // Question exceeds all defined ranges ‚Üí return LAST image (not first)
            return {
                imageIndex: images.length - 1,
                image: images[images.length - 1],
                questionInImage: 0
            };
        }
        
        // Load current image
        function loadCurrentImage() {
            let images = [];
            if (currentSubject === 'physics') images = physicsImages;
            else if (currentSubject === 'maths') images = mathsImages;
            else images = chemistryImages;
            
            if (images.length > 0 && currentImageIndex < images.length) {
                const image = images[currentImageIndex];
                const imgElement = document.getElementById('question-image');
                
                // Check if this is a loaded image (has dataURL) or a path-based image
                if (image.path && image.path.startsWith('data:')) {
                    // This is a loaded image from folder - just display it directly
                    imgElement.src = image.path;
                    console.log(`‚úì Displaying loaded image: ${image.name || 'Image ' + (currentImageIndex + 1)}`);
                } else {
                    // This is a path-based image - try flexible loading
                    console.log(`Loading image: ${image.path} for ${currentSubject} image ${currentImageIndex + 1}`);
                    
                    const basePath = image.path;
                    const pathParts = basePath.split('/');
                    const folder = pathParts.slice(0, -1).join('/');
                    const imageNumber = image.id;
                    
                    // All possible naming patterns
                    const patterns = [
                        `q${imageNumber}`,
                        `Q${imageNumber}`,
                        `question${imageNumber}`,
                        `Question${imageNumber}`,
                        `${imageNumber}`,
                        `img${imageNumber}`,
                        `image${imageNumber}`,
                        `${String(imageNumber).padStart(2, '0')}`,
                        `0${imageNumber}`,
                    ];
                    
                    const extensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'JPG', 'JPEG', 'PNG', 'GIF', 'WEBP'];
                    
                    let loaded = false;
                    let attemptCount = 0;
                    const totalAttempts = patterns.length * extensions.length;
                    
                    // Try all combinations
                    for (let pattern of patterns) {
                        for (let ext of extensions) {
                            if (!loaded) {
                                const testSrc = `${folder}/${pattern}.${ext}`;
                                const testImg = new Image();
                                
                                testImg.onload = function() {
                                    if (!loaded) {
                                        loaded = true;
                                        imgElement.src = testSrc;
                                        console.log(`‚úì Successfully loaded: ${testSrc}`);
                                    }
                                };
                                
                                testImg.onerror = function() {
                                    attemptCount++;
                                    if (attemptCount >= totalAttempts && !loaded) {
                                        console.error(`‚úó Failed to load image after trying all combinations for image #${imageNumber}`);
                                        imgElement.src = 'https://via.placeholder.com/800x600/ff0000/ffffff?text=Image+Not+Found';
                                    }
                                };
                                
                                testImg.src = testSrc;
                            }
                        }
                    }
                }
            }
        }
        
        // Update image navigation UI
        function updateImageNavigation() {
            let images = [];
            if (currentSubject === 'physics') images = physicsImages;
            else if (currentSubject === 'maths') images = mathsImages;
            else images = chemistryImages;
            
            const prevBtn = document.getElementById('prev-image-btn');
            const nextBtn = document.getElementById('next-image-btn');
            const counter = document.getElementById('image-counter');
            
            if (autoAdvanceImage) {
                // Disable manual nav when auto-advance is on
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                prevBtn.title = 'Disabled: Auto-advance is ON';
                nextBtn.title = 'Disabled: Auto-advance is ON';
            } else {
                prevBtn.disabled = currentImageIndex === 0;
                nextBtn.disabled = currentImageIndex === images.length - 1;
                prevBtn.title = '';
                nextBtn.title = '';
            }
            
            counter.textContent = `Image ${currentImageIndex + 1} of ${images.length}`;
        }
        
        // Generate question selector for current image
        // Get absolute question number (1-75)
        function getAbsoluteQuestionNumber(subject, subjectQuestionNumber) {
            if (subject === 'physics') {
                return subjectQuestionNumber;
            } else if (subject === 'maths') {
                return physicsCount + subjectQuestionNumber;
            } else {
                return physicsCount + mathsCount + subjectQuestionNumber;
            }
        }
        
        // Navigate to previous image
        function prevImage() {
            if (autoAdvanceImage) return; // Disabled when auto-advance is on
            let images = [];
            if (currentSubject === 'physics') images = physicsImages;
            else if (currentSubject === 'maths') images = mathsImages;
            else images = chemistryImages;
            
            if (currentImageIndex > 0) {
                currentImageIndex--;
                manualImageChange = true; // User manually changed image
                loadCurrentImage();
                updateImageNavigation();
            }
        }
        
        // Navigate to next image
        function nextImage() {
            if (autoAdvanceImage) return; // Disabled when auto-advance is on
            let images = [];
            if (currentSubject === 'physics') images = physicsImages;
            else if (currentSubject === 'maths') images = mathsImages;
            else images = chemistryImages;
            
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                manualImageChange = true; // User manually changed image
                loadCurrentImage();
                updateImageNavigation();
            }
        }
        
        // Get question number within subject (1-25)
        function getSubjectQuestionNumber(questionNumber) {
            if (questionNumber <= physicsCount) {
                return questionNumber;
            } else if (questionNumber <= physicsCount + mathsCount) {
                return questionNumber - physicsCount;
            } else {
                return questionNumber - physicsCount - mathsCount;
            }
        }
        
        // Load saved answer for current question
        function loadAnswerForQuestion() {
            // Clear all option selections
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Get the answer for current question
            const subjectQuestionNumber = getSubjectQuestionNumber(currentQuestion);
            let answer = '';
            
            if (currentSubject === 'physics') {
                answer = physicsAnswers[subjectQuestionNumber - 1];
            } else if (currentSubject === 'maths') {
                answer = mathsAnswers[subjectQuestionNumber - 1];
            } else if (currentSubject === 'chemistry') {
                answer = chemistryAnswers[subjectQuestionNumber - 1];
            }
            
            // Select the option if answered
            if (answer && ['A', 'B', 'C', 'D'].includes(answer)) {
                const optionElement = document.querySelector(`.option[data-option="${answer}"]`);
                if (optionElement) {
                    optionElement.classList.add('selected');
                }
            }
        }
        
        // Select an option
        function selectOption(option) {
            if (testSubmitted) return;
            
            const subjectQuestionNumber = getSubjectQuestionNumber(currentQuestion);
            let currentAnswer = '';
            if (currentSubject === 'physics') currentAnswer = physicsAnswers[subjectQuestionNumber - 1];
            else if (currentSubject === 'maths') currentAnswer = mathsAnswers[subjectQuestionNumber - 1];
            else if (currentSubject === 'chemistry') currentAnswer = chemistryAnswers[subjectQuestionNumber - 1];
            
            // Agar same option dobara click kiya toh clear karo
            if (currentAnswer === option) {
                document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                if (currentSubject === 'physics') physicsAnswers[subjectQuestionNumber - 1] = '';
                else if (currentSubject === 'maths') mathsAnswers[subjectQuestionNumber - 1] = '';
                else if (currentSubject === 'chemistry') chemistryAnswers[subjectQuestionNumber - 1] = '';
                updatePalette();
                updateMarkForReviewButton();
                return;
            }
            
            // Clear previous selection
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            const optionElement = document.querySelector(`.option[data-option="${option}"]`);
            optionElement.classList.add('selected');
            
            // Save answer
            if (currentSubject === 'physics') {
                physicsAnswers[subjectQuestionNumber - 1] = option;
                physicsMarked[subjectQuestionNumber - 1] = false;
            } else if (currentSubject === 'maths') {
                mathsAnswers[subjectQuestionNumber - 1] = option;
                mathsMarked[subjectQuestionNumber - 1] = false;
            } else if (currentSubject === 'chemistry') {
                chemistryAnswers[subjectQuestionNumber - 1] = option;
                chemistryMarked[subjectQuestionNumber - 1] = false;
            }
            
            // Update UI
            updatePalette();
            updateMarkForReviewButton();
        }
        
        // Mark for review
        function markForReview() {
            if (testSubmitted) return;
            
            const subjectQuestionNumber = getSubjectQuestionNumber(currentQuestion);
            let isMarked = false;
            
            if (currentSubject === 'physics') {
                physicsMarked[subjectQuestionNumber - 1] = !physicsMarked[subjectQuestionNumber - 1];
                isMarked = physicsMarked[subjectQuestionNumber - 1];
            } else if (currentSubject === 'maths') {
                mathsMarked[subjectQuestionNumber - 1] = !mathsMarked[subjectQuestionNumber - 1];
                isMarked = mathsMarked[subjectQuestionNumber - 1];
            } else if (currentSubject === 'chemistry') {
                chemistryMarked[subjectQuestionNumber - 1] = !chemistryMarked[subjectQuestionNumber - 1];
                isMarked = chemistryMarked[subjectQuestionNumber - 1];
            }
            
            // Update button text
            const btn = document.getElementById('mark-review-btn');
            btn.textContent = isMarked ? 'Unmark Review' : 'Mark for Review';
            btn.classList.toggle('btn-warning', !isMarked);
            btn.classList.toggle('btn-success', isMarked);
            
            // Update UI
            updatePalette();
        }
        
        // Update mark for review button
        function updateMarkForReviewButton() {
            const subjectQuestionNumber = getSubjectQuestionNumber(currentQuestion);
            let isMarked = false;
            
            if (currentSubject === 'physics') {
                isMarked = physicsMarked[subjectQuestionNumber - 1];
            } else if (currentSubject === 'maths') {
                isMarked = mathsMarked[subjectQuestionNumber - 1];
            } else if (currentSubject === 'chemistry') {
                isMarked = chemistryMarked[subjectQuestionNumber - 1];
            }
            
            const btn = document.getElementById('mark-review-btn');
            btn.textContent = isMarked ? 'Unmark Review' : 'Mark for Review';
            btn.classList.toggle('btn-warning', !isMarked);
            btn.classList.toggle('btn-success', isMarked);
        }
        
        // Navigate to previous question
        function prevQuestion() {
            if (currentQuestion > 1) {
                loadQuestion(currentQuestion - 1);
            }
        }
        
        // Navigate to next question
        function nextQuestion() {
            if (currentQuestion < totalQuestions) {
                loadQuestion(currentQuestion + 1);
            }
        }
        
        // Navigate to specific question
        function navigateToQuestion(questionNumber) {
            if (questionNumber >= 1 && questionNumber <= totalQuestions) {
                loadQuestion(questionNumber);
            }
        }
        
        // Switch subject via tabs
        function switchSubject(subject) {
            // Save current subject's state before switching
            subjectMemory[currentSubject].lastQuestion = currentQuestion;
            subjectMemory[currentSubject].lastImageIndex = currentImageIndex;
            
            let questionNumber = 1;
            
            // Check if we have a saved position for this subject
            if (subjectMemory[subject].lastQuestion !== null) {
                // Restore to last visited question in this subject
                questionNumber = subjectMemory[subject].lastQuestion;
                currentImageIndex = subjectMemory[subject].lastImageIndex;
            } else {
                // First time visiting this subject - go to first question
                if (subject === 'physics') {
                    questionNumber = 1;
                } else if (subject === 'maths') {
                    questionNumber = physicsCount + 1;
                } else if (subject === 'chemistry') {
                    questionNumber = physicsCount + mathsCount + 1;
                }
                currentImageIndex = 0;
            }
            
            isSubjectSwitching = true; // Mark that we're switching subjects
            loadQuestion(questionNumber);
        }
        
        // Update subject tabs UI
        function updateSubjectTabs() {
            document.querySelectorAll('.subject-tab').forEach(tab => {
                const tabSubject = tab.getAttribute('data-subject');
                
                if (tabSubject === currentSubject) {
                    tab.classList.remove('inactive');
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                    tab.classList.add('inactive');
                }
            });
        }
        
        // Update question palette UI
        function updatePalette() {
            // Update all palette buttons
            for (let i = 1; i <= totalQuestions; i++) {
                const paletteBtn = document.querySelector(`.palette-btn[data-question="${i}"]`);
                
                if (paletteBtn) {
                    // Remove all state classes
                    paletteBtn.classList.remove('not-visited', 'not-answered', 'answered', 'marked', 'current');
                    
                    // Determine which subject this question belongs to
                    let answer = '';
                    let isMarked = false;
                    let subjectQuestionNumber = 0;
                    
                    if (i <= physicsCount) {
                        subjectQuestionNumber = i;
                        answer = physicsAnswers[subjectQuestionNumber - 1];
                        isMarked = physicsMarked[subjectQuestionNumber - 1];
                    } else if (i <= physicsCount + mathsCount) {
                        subjectQuestionNumber = i - physicsCount;
                        answer = mathsAnswers[subjectQuestionNumber - 1];
                        isMarked = mathsMarked[subjectQuestionNumber - 1];
                    } else {
                        subjectQuestionNumber = i - physicsCount - mathsCount;
                        answer = chemistryAnswers[subjectQuestionNumber - 1];
                        isMarked = chemistryMarked[subjectQuestionNumber - 1];
                    }
                    
                    // Set state class
                    if (i === currentQuestion) {
                        paletteBtn.classList.add('current');
                    }
                    
                    if (isMarked) {
                        paletteBtn.classList.add('marked');
                    } else if (answer === '') {
                        paletteBtn.classList.add('not-answered');
                    } else {
                        paletteBtn.classList.add('answered');
                    }
                }
            }
        }
        
        // Timer functions
        function startTimer() {
            console.log('Starting timer with totalSeconds:', totalSeconds);
            updateTimerDisplay();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTimer() {
            if (totalSeconds <= 0) {
                clearInterval(timerInterval);
                submitTest(); // Auto-submit when time is up
                return;
            }
            
            totalSeconds--;
            console.log('Timer tick - Remaining seconds:', totalSeconds);
            updateTimerDisplay();
        }
        
        function updateTimerDisplay() {
            const totalMinutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const timerElement = document.getElementById('timer');
            
            console.log('Updating timer display. Minutes:', totalMinutes, 'Seconds:', seconds, 'Element found:', !!timerElement);
            
            if (timerElement) {
                // Format: MM:SS
                timerElement.textContent = `${totalMinutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Change color when time is running low
                if (totalMinutes < 5) {
                    timerElement.style.color = '#ff5252'; // Red when less than 5 min
                } else if (totalMinutes < 15) {
                    timerElement.style.color = '#ffa726'; // Orange when less than 15 min
                } else {
                    timerElement.style.color = '#ffeb3b'; // Yellow (default)
                }
            } else {
                console.error('Timer element not found!');
            }
        }
        
        // Toggle submit button based on checkbox
        function toggleSubmitBtn() {
            const checkbox = document.getElementById('submit-confirm-check');
            const btn = document.getElementById('submit-btn');
            if (checkbox && btn) {
                btn.disabled = !checkbox.checked;
                btn.style.opacity = checkbox.checked ? '1' : '0.4';
                btn.style.cursor = checkbox.checked ? 'pointer' : 'not-allowed';
            }
        }
        
        // Submit test
        function submitTest() {
            if (testSubmitted) return;
            
            if (!confirm("Are you sure you want to submit the test? You cannot return to the test after submission.")) {
                return;
            }
            
            // Stop timer
            clearInterval(timerInterval);
            
            // Record time spent on current question
            const now = new Date();
            const timeElapsed = Math.floor((now - questionStartTime) / 1000);
            timeSpent[currentQuestion - 1] += timeElapsed;
            
            // Mark test as submitted
            testSubmitted = true;
            
            // Lock all UI elements
            document.querySelectorAll('.option').forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            document.querySelectorAll('.palette-btn').forEach(btn => {
                btn.style.pointerEvents = 'none';
            });
            
            document.getElementById('prev-btn').disabled = true;
            document.getElementById('next-btn').disabled = true;
            document.getElementById('mark-review-btn').disabled = true;
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('prev-image-btn').disabled = true;
            document.getElementById('next-image-btn').disabled = true;
            
            // Load answer key images and inputs
            loadAnswerKeyInputs();
            
            // Show submission modal
            document.getElementById('submission-modal').style.display = 'flex';
        }
        
        // Load answer key images and inputs
        function loadAnswerKeyInputs() {
            // Clear previous images
            document.getElementById('physics-answer-images').innerHTML = '';
            document.getElementById('maths-answer-images').innerHTML = '';
            document.getElementById('chemistry-answer-images').innerHTML = '';
            
            // Load answer key images for Physics
            physicsAnswerImages.forEach((img, index) => {
                const imgElement = document.createElement('img');
                imgElement.src = img.path;
                imgElement.alt = `Physics Answer Key ${index + 1}`;
                imgElement.className = 'answer-key-image';
                document.getElementById('physics-answer-images').appendChild(imgElement);
            });
            
            // Load answer key images for Maths
            mathsAnswerImages.forEach((img, index) => {
                const imgElement = document.createElement('img');
                imgElement.src = img.path;
                imgElement.alt = `Maths Answer Key ${index + 1}`;
                imgElement.className = 'answer-key-image';
                document.getElementById('maths-answer-images').appendChild(imgElement);
            });
            
            // Load answer key images for Chemistry
            chemistryAnswerImages.forEach((img, index) => {
                const imgElement = document.createElement('img');
                imgElement.src = img.path;
                imgElement.alt = `Chemistry Answer Key ${index + 1}`;
                imgElement.className = 'answer-key-image';
                document.getElementById('chemistry-answer-images').appendChild(imgElement);
            });
            
            // Auto-fill answer inputs from txt keys if available
            if (physicsTxtAnswerKey) {
                const physicsInput = document.getElementById('physics-answers-input');
                physicsInput.value = physicsTxtAnswerKey.substring(0, physicsCount);
                document.getElementById('physics-answers-length').textContent = physicsInput.value.length;
            }
            if (mathsTxtAnswerKey) {
                const mathsInput = document.getElementById('maths-answers-input');
                mathsInput.value = mathsTxtAnswerKey.substring(0, mathsCount);
                document.getElementById('maths-answers-length').textContent = mathsInput.value.length;
            }
            if (chemistryTxtAnswerKey) {
                const chemInput = document.getElementById('chemistry-answers-input');
                chemInput.value = chemistryTxtAnswerKey.substring(0, chemistryCount);
                document.getElementById('chemistry-answers-length').textContent = chemInput.value.length;
            }
        }
        
        // Cancel submit (go back to test)
        function cancelSubmit() {
            // Only allow cancel if test is not submitted
            if (!testSubmitted) {
                // Hide modal
                document.getElementById('submission-modal').style.display = 'none';
                
                // Re-enable UI
                document.querySelectorAll('.option').forEach(option => {
                    option.style.pointerEvents = 'auto';
                });
                
                document.querySelectorAll('.palette-btn').forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                });
                
                document.getElementById('prev-btn').disabled = false;
                document.getElementById('next-btn').disabled = false;
                document.getElementById('mark-review-btn').disabled = false;
                // Reset checkbox and keep submit locked
                const confirmCheck = document.getElementById('submit-confirm-check');
                if (confirmCheck) { confirmCheck.checked = false; }
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').style.opacity = '0.4';
                document.getElementById('submit-btn').style.cursor = 'not-allowed';
                document.getElementById('prev-image-btn').disabled = false;
                document.getElementById('next-image-btn').disabled = false;
                
                // Restart timer
                startTimer();
            }
        }
        
        // Calculate results
        function calculateResults() {
            // Get answer keys from inputs
            const physicsAnswerStr = document.getElementById('physics-answers-input').value.trim().toUpperCase();
            const mathsAnswerStr = document.getElementById('maths-answers-input').value.trim().toUpperCase();
            const chemistryAnswerStr = document.getElementById('chemistry-answers-input').value.trim().toUpperCase();
            
            // Validate inputs
            if (physicsAnswerStr.length !== physicsCount) {
                alert(`Please enter exactly ${physicsCount} answers for Physics`);
                return;
            }
            
            if (mathsAnswerStr.length !== mathsCount) {
                alert(`Please enter exactly ${mathsCount} answers for Mathematics`);
                return;
            }
            
            if (chemistryAnswerStr.length !== chemistryCount) {
                alert(`Please enter exactly ${chemistryCount} answers for Chemistry`);
                return;
            }
            
            // Convert to arrays
            physicsKey = physicsAnswerStr.split('');
            mathsKey = mathsAnswerStr.split('');
            chemistryKey = chemistryAnswerStr.split('');
            
            // Calculate and display results
            calculateAndDisplayResults();
            
            // Hide submission modal, show results modal
            document.getElementById('submission-modal').style.display = 'none';
            document.getElementById('results-modal').style.display = 'flex';
        }
        
        // Calculate and display results
        function calculateAndDisplayResults() {
            // Calculate results
            let totalCorrect = 0;
            let totalIncorrect = 0;
            let totalUnattempted = 0;
            let totalMarked = 0;
            
            let physicsCorrect = 0;
            let physicsIncorrect = 0;
            let physicsUnattempted = 0;
            let physicsMarkedCount = 0;
            
            let mathsCorrect = 0;
            let mathsIncorrect = 0;
            let mathsUnattempted = 0;
            let mathsMarkedCount = 0;
            
            let chemistryCorrect = 0;
            let chemistryIncorrect = 0;
            let chemistryUnattempted = 0;
            let chemistryMarkedCount = 0;
            
            // Calculate physics results
            for (let i = 0; i < physicsCount; i++) {
                const userAnswer = physicsAnswers[i] || '';
                const correctAnswer = physicsKey[i] || '';
                
                if (physicsMarked[i]) physicsMarkedCount++;
                
                if (userAnswer === '') {
                    physicsUnattempted++;
                } else if (userAnswer === correctAnswer) {
                    physicsCorrect++;
                } else {
                    physicsIncorrect++;
                }
            }
            
            // Calculate maths results
            for (let i = 0; i < mathsCount; i++) {
                const userAnswer = mathsAnswers[i] || '';
                const correctAnswer = mathsKey[i] || '';
                
                if (mathsMarked[i]) mathsMarkedCount++;
                
                if (userAnswer === '') {
                    mathsUnattempted++;
                } else if (userAnswer === correctAnswer) {
                    mathsCorrect++;
                } else {
                    mathsIncorrect++;
                }
            }
            
            // Calculate chemistry results
            for (let i = 0; i < chemistryCount; i++) {
                const userAnswer = chemistryAnswers[i] || '';
                const correctAnswer = chemistryKey[i] || '';
                
                if (chemistryMarked[i]) chemistryMarkedCount++;
                
                if (userAnswer === '') {
                    chemistryUnattempted++;
                } else if (userAnswer === correctAnswer) {
                    chemistryCorrect++;
                } else {
                    chemistryIncorrect++;
                }
            }
            
            // Calculate totals
            totalCorrect = physicsCorrect + mathsCorrect + chemistryCorrect;
            totalIncorrect = physicsIncorrect + mathsIncorrect + chemistryIncorrect;
            totalUnattempted = physicsUnattempted + mathsUnattempted + chemistryUnattempted;
            totalMarked = physicsMarkedCount + mathsMarkedCount + chemistryMarkedCount;
            
            // Calculate scores (+4 for correct, -1 for incorrect, 0 for unattempted)
            const physicsScore = (physicsCorrect * 4) - physicsIncorrect;
            const mathsScore = (mathsCorrect * 4) - mathsIncorrect;
            const chemistryScore = (chemistryCorrect * 4) - chemistryIncorrect;
            const totalScore = physicsScore + mathsScore + chemistryScore;
            
            // Calculate maximum possible marks
            const maxMarks = totalQuestions * 4;
            
            // Calculate accuracy percentages
            const physicsAnswered = physicsCorrect + physicsIncorrect;
            const physicsAccuracy = physicsAnswered > 0 ? Math.round((physicsCorrect / physicsAnswered) * 100) : 0;
            
            const mathsAnswered = mathsCorrect + mathsIncorrect;
            const mathsAccuracy = mathsAnswered > 0 ? Math.round((mathsCorrect / mathsAnswered) * 100) : 0;
            
            const chemistryAnswered = chemistryCorrect + chemistryIncorrect;
            const chemistryAccuracy = chemistryAnswered > 0 ? Math.round((chemistryCorrect / chemistryAnswered) * 100) : 0;
            
            const totalAnswered = totalCorrect + totalIncorrect;
            const totalAccuracy = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
            
            // Calculate total time taken
            const now = new Date();
            const timeTakenSeconds = Math.floor((now - startTime) / 1000);
            const timeTakenMinutes = Math.floor(timeTakenSeconds / 60);
            const timeTakenHours = Math.floor(timeTakenMinutes / 60);
            const timeTakenFormatted = 
                `${timeTakenHours.toString().padStart(2, '0')}:${(timeTakenMinutes % 60).toString().padStart(2, '0')}:${(timeTakenSeconds % 60).toString().padStart(2, '0')}`;
            
            // Find max time spent for scaling
            const maxTimeSpent = Math.max(...timeSpent);
            
            // Display results
            document.getElementById('total-score').textContent = `${totalScore}/${maxMarks}`;
            document.getElementById('total-correct').textContent = totalCorrect;
            document.getElementById('total-incorrect').textContent = totalIncorrect;
            document.getElementById('total-unattempted').textContent = totalUnattempted;
            document.getElementById('total-marked').textContent = totalMarked;
            document.getElementById('accuracy').textContent = `${totalAccuracy}%`;
            document.getElementById('time-taken').textContent = timeTakenFormatted;
            
            // Display subject-wise results
            document.getElementById('physics-total').textContent = physicsCount;
            document.getElementById('physics-score').textContent = physicsScore;
            document.getElementById('physics-correct').textContent = physicsCorrect;
            document.getElementById('physics-incorrect').textContent = physicsIncorrect;
            document.getElementById('physics-marked').textContent = physicsMarkedCount;
            document.getElementById('physics-accuracy').textContent = `${physicsAccuracy}%`;
            
            document.getElementById('maths-total').textContent = mathsCount;
            document.getElementById('maths-score').textContent = mathsScore;
            document.getElementById('maths-correct').textContent = mathsCorrect;
            document.getElementById('maths-incorrect').textContent = mathsIncorrect;
            document.getElementById('maths-marked').textContent = mathsMarkedCount;
            document.getElementById('maths-accuracy').textContent = `${mathsAccuracy}%`;
            
            document.getElementById('chemistry-total').textContent = chemistryCount;
            document.getElementById('chemistry-score').textContent = chemistryScore;
            document.getElementById('chemistry-correct').textContent = chemistryCorrect;
            document.getElementById('chemistry-incorrect').textContent = chemistryIncorrect;
            document.getElementById('chemistry-marked').textContent = chemistryMarkedCount;
            document.getElementById('chemistry-accuracy').textContent = `${chemistryAccuracy}%`;
            
            // Generate time spent analysis
            const timeSpentResults = document.getElementById('time-spent-results');
            timeSpentResults.innerHTML = '';
            
            for (let i = 0; i < totalQuestions; i++) {
                const row = document.createElement('tr');
                const timeValue = timeSpent[i];
                const percentage = maxTimeSpent > 0 ? (timeValue / maxTimeSpent) * 100 : 0;
                
                let subject = '';
                let qNo = i + 1;
                let isMarked = false;
                let status = '';
                
                if (i < physicsCount) {
                    subject = 'Physics';
                    qNo = i + 1;
                    isMarked = physicsMarked[i];
                    status = physicsAnswers[i] ? 'Answered' : 'Unattempted';
                    if (isMarked) status = 'Marked';
                } else if (i < physicsCount + mathsCount) {
                    subject = 'Mathematics';
                    qNo = i - physicsCount + 1;
                    isMarked = mathsMarked[i - physicsCount];
                    status = mathsAnswers[i - physicsCount] ? 'Answered' : 'Unattempted';
                    if (isMarked) status = 'Marked';
                } else {
                    subject = 'Chemistry';
                    qNo = i - physicsCount - mathsCount + 1;
                    isMarked = chemistryMarked[i - physicsCount - mathsCount];
                    status = chemistryAnswers[i - physicsCount - mathsCount] ? 'Answered' : 'Unattempted';
                    if (isMarked) status = 'Marked';
                }
                
                const minutes = Math.floor(timeValue / 60);
                const seconds = timeValue % 60;
                const timeFormatted = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${subject}</td>
                    <td>${timeFormatted}</td>
                    <td>
                        <div class="time-bar-container">
                            <div class="time-bar" style="width: ${percentage}%"></div>
                        </div>
                    </td>
                    <td class="${isMarked ? 'warning' : ''}">${status}</td>
                `;
                
                timeSpentResults.appendChild(row);
            }
            
            // Generate detailed results table
            const detailedResults = document.getElementById('detailed-results');
            detailedResults.innerHTML = '';
            
            // Physics questions
            for (let i = 0; i < physicsCount; i++) {
                const row = document.createElement('tr');
                const userAnswer = physicsAnswers[i] || '';
                const correctAnswer = physicsKey[i] || '';
                let status = '';
                let score = 0;
                const isMarked = physicsMarked[i];
                
                if (userAnswer === '') {
                    status = 'Unattempted';
                    score = 0;
                } else if (userAnswer === correctAnswer) {
                    status = 'Correct';
                    score = 4;
                } else {
                    status = 'Incorrect';
                    score = -1;
                }
                
                row.innerHTML = `
                    <td>Physics</td>
                    <td>${i + 1}</td>
                    <td>${userAnswer || '-'}</td>
                    <td>${correctAnswer}</td>
                    <td class="${status === 'Correct' ? 'success' : status === 'Incorrect' ? 'highlight' : ''}">${status}</td>
                    <td class="${score > 0 ? 'success' : score < 0 ? 'highlight' : ''}">${score > 0 ? '+' : ''}${score}</td>
                    <td class="${isMarked ? 'warning' : ''}">${isMarked ? 'Yes' : 'No'}</td>
                `;
                
                detailedResults.appendChild(row);
            }
            
            // Maths questions
            for (let i = 0; i < mathsCount; i++) {
                const row = document.createElement('tr');
                const userAnswer = mathsAnswers[i] || '';
                const correctAnswer = mathsKey[i] || '';
                let status = '';
                let score = 0;
                const isMarked = mathsMarked[i];
                
                if (userAnswer === '') {
                    status = 'Unattempted';
                    score = 0;
                } else if (userAnswer === correctAnswer) {
                    status = 'Correct';
                    score = 4;
                } else {
                    status = 'Incorrect';
                    score = -1;
                }
                
                row.innerHTML = `
                    <td>Mathematics</td>
                    <td>${i + 1}</td>
                    <td>${userAnswer || '-'}</td>
                    <td>${correctAnswer}</td>
                    <td class="${status === 'Correct' ? 'success' : status === 'Incorrect' ? 'highlight' : ''}">${status}</td>
                    <td class="${score > 0 ? 'success' : score < 0 ? 'highlight' : ''}">${score > 0 ? '+' : ''}${score}</td>
                    <td class="${isMarked ? 'warning' : ''}">${isMarked ? 'Yes' : 'No'}</td>
                `;
                
                detailedResults.appendChild(row);
            }
            
            // Chemistry questions
            for (let i = 0; i < chemistryCount; i++) {
                const row = document.createElement('tr');
                const userAnswer = chemistryAnswers[i] || '';
                const correctAnswer = chemistryKey[i] || '';
                let status = '';
                let score = 0;
                const isMarked = chemistryMarked[i];
                
                if (userAnswer === '') {
                    status = 'Unattempted';
                    score = 0;
                } else if (userAnswer === correctAnswer) {
                    status = 'Correct';
                    score = 4;
                } else {
                    status = 'Incorrect';
                    score = -1;
                }
                
                row.innerHTML = `
                    <td>Chemistry</td>
                    <td>${i + 1}</td>
                    <td>${userAnswer || '-'}</td>
                    <td>${correctAnswer}</td>
                    <td class="${status === 'Correct' ? 'success' : status === 'Incorrect' ? 'highlight' : ''}">${status}</td>
                    <td class="${score > 0 ? 'success' : score < 0 ? 'highlight' : ''}">${score > 0 ? '+' : ''}${score}</td>
                    <td class="${isMarked ? 'warning' : ''}">${isMarked ? 'Yes' : 'No'}</td>
                `;
                
                detailedResults.appendChild(row);
            }
            
            // === ENHANCED ANALYTICS ===
            
            // 1. Calculate Performance Insights
            // Calculate average time per attempted question
            const attemptedQuestions = totalAnswered;
            const totalTimeInSeconds = timeTakenSeconds;
            const avgTimePerQuestion = attemptedQuestions > 0 ? Math.floor(totalTimeInSeconds / attemptedQuestions) : 0;
            const avgMinutes = Math.floor(avgTimePerQuestion / 60);
            const avgSeconds = avgTimePerQuestion % 60;
            const avgTimeFormatted = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            // Find fastest subject (lowest avg time per attempted question)
            const physicsTimeSpent = timeSpent.slice(0, physicsCount).reduce((a, b) => a + b, 0);
            const mathsTimeSpent = timeSpent.slice(physicsCount, physicsCount + mathsCount).reduce((a, b) => a + b, 0);
            const chemistryTimeSpent = timeSpent.slice(physicsCount + mathsCount).reduce((a, b) => a + b, 0);
            
            const physicsAvgTime = physicsAnswered > 0 ? physicsTimeSpent / physicsAnswered : Infinity;
            const mathsAvgTime = mathsAnswered > 0 ? mathsTimeSpent / mathsAnswered : Infinity;
            const chemistryAvgTime = chemistryAnswered > 0 ? chemistryTimeSpent / chemistryAnswered : Infinity;
            
            let fastestSubject = 'Physics';
            let fastestTime = physicsAvgTime;
            if (mathsAvgTime < fastestTime && mathsAnswered > 0) {
                fastestSubject = 'Mathematics';
                fastestTime = mathsAvgTime;
            }
            if (chemistryAvgTime < fastestTime && chemistryAnswered > 0) {
                fastestSubject = 'Chemistry';
                fastestTime = chemistryAvgTime;
            }
            const fastestTimeMin = Math.floor(fastestTime / 60);
            const fastestTimeSec = Math.floor(fastestTime % 60);
            
            // Find best subject (highest accuracy)
            let bestSubject = 'Physics';
            let bestAccuracy = physicsAccuracy;
            if (mathsAccuracy > bestAccuracy && mathsAnswered > 0) {
                bestSubject = 'Mathematics';
                bestAccuracy = mathsAccuracy;
            }
            if (chemistryAccuracy > bestAccuracy && chemistryAnswered > 0) {
                bestSubject = 'Chemistry';
                bestAccuracy = chemistryAccuracy;
            }
            
            // Calculate efficiency rate (correct answers / attempted questions)
            const efficiencyRate = attemptedQuestions > 0 ? Math.round((totalCorrect / attemptedQuestions) * 100) : 0;
            
            // Update insights
            document.getElementById('fastest-subject').textContent = fastestSubject;
            document.getElementById('fastest-time').textContent = `${fastestTimeMin}:${fastestTimeSec.toString().padStart(2, '0')} per question`;
            document.getElementById('best-subject').textContent = bestSubject;
            document.getElementById('best-accuracy').textContent = `${bestAccuracy}% accuracy`;
            document.getElementById('avg-time-per-q').textContent = avgTimeFormatted;
            document.getElementById('efficiency-rate').textContent = `${efficiencyRate}%`;
            
            // 2. Generate Strengths & Weaknesses
            const strengthsList = document.getElementById('strengths-list');
            const weaknessesList = document.getElementById('weaknesses-list');
            strengthsList.innerHTML = '';
            weaknessesList.innerHTML = '';
            
            const strengths = [];
            const weaknesses = [];
            
            // Analyze subject performance
            if (physicsAccuracy >= 75 && physicsAnswered >= 5) {
                strengths.push(`Strong performance in Physics (${physicsAccuracy}% accuracy)`);
            } else if (physicsAccuracy < 50 && physicsAnswered >= 5) {
                weaknesses.push(`Need improvement in Physics (${physicsAccuracy}% accuracy)`);
            }
            
            if (mathsAccuracy >= 75 && mathsAnswered >= 5) {
                strengths.push(`Strong performance in Mathematics (${mathsAccuracy}% accuracy)`);
            } else if (mathsAccuracy < 50 && mathsAnswered >= 5) {
                weaknesses.push(`Need improvement in Mathematics (${mathsAccuracy}% accuracy)`);
            }
            
            if (chemistryAccuracy >= 75 && chemistryAnswered >= 5) {
                strengths.push(`Strong performance in Chemistry (${chemistryAccuracy}% accuracy)`);
            } else if (chemistryAccuracy < 50 && chemistryAnswered >= 5) {
                weaknesses.push(`Need improvement in Chemistry (${chemistryAccuracy}% accuracy)`);
            }
            
            // Analyze speed
            if (avgTimePerQuestion < 120) {
                strengths.push(`Good time management (${avgTimeFormatted} avg per question)`);
            } else if (avgTimePerQuestion > 180) {
                weaknesses.push(`Slow pace - Try to improve speed (${avgTimeFormatted} avg per question)`);
            }
            
            // Analyze completion rate
            const completionRate = (totalAnswered / totalQuestions) * 100;
            if (completionRate >= 90) {
                strengths.push(`High attempt rate (${Math.round(completionRate)}% attempted)`);
            } else if (completionRate < 70) {
                weaknesses.push(`Low attempt rate (${Math.round(completionRate)}% attempted) - Try to attempt more questions`);
            }
            
            // Analyze accuracy
            if (totalAccuracy >= 80) {
                strengths.push(`Excellent accuracy (${totalAccuracy}%)`);
            } else if (totalAccuracy < 60) {
                weaknesses.push(`Work on concept clarity to improve accuracy (${totalAccuracy}%)`);
            }
            
            // Analyze marking behavior
            if (totalMarked > totalQuestions * 0.3) {
                weaknesses.push(`Too many questions marked for review (${totalMarked}) - Be more confident`);
            }
            
            // Display strengths
            if (strengths.length === 0) {
                strengthsList.innerHTML = '<li style="color: #999;">Keep practicing to build your strengths!</li>';
            } else {
                strengths.forEach(strength => {
                    const li = document.createElement('li');
                    li.textContent = '‚úì ' + strength;
                    strengthsList.appendChild(li);
                });
            }
            
            // Display weaknesses
            if (weaknesses.length === 0) {
                weaknessesList.innerHTML = '<li style="color: #999;">Great job! Keep up the good work!</li>';
            } else {
                weaknesses.forEach(weakness => {
                    const li = document.createElement('li');
                    li.textContent = '‚Ä¢ ' + weakness;
                    weaknessesList.appendChild(li);
                });
            }
            
            // 3. Update Question Status Distribution Bar
            const totalQs = totalQuestions;
            const correctPercent = (totalCorrect / totalQs) * 100;
            const incorrectPercent = (totalIncorrect / totalQs) * 100;
            const unattemptedPercent = (totalUnattempted / totalQs) * 100;
            
            document.getElementById('correct-bar').style.width = correctPercent + '%';
            document.getElementById('incorrect-bar').style.width = incorrectPercent + '%';
            document.getElementById('unattempted-bar').style.width = unattemptedPercent + '%';
            
            document.getElementById('correct-bar-label').textContent = totalCorrect;
            document.getElementById('incorrect-bar-label').textContent = totalIncorrect;
            document.getElementById('unattempted-bar-label').textContent = totalUnattempted;
            
            // 4. Save test to history
            const testData = {
                date: new Date().toISOString(),
                userName: userName,
                testName: testName,
                totalScore: totalScore,
                maxMarks: maxMarks,
                totalCorrect: totalCorrect,
                totalIncorrect: totalIncorrect,
                totalUnattempted: totalUnattempted,
                totalMarked: totalMarked,
                accuracy: totalAccuracy,
                timeTaken: timeTakenFormatted,
                totalQuestions: totalQuestions,
                physicsCount: physicsCount,
                mathsCount: mathsCount,
                chemistryCount: chemistryCount,
                physicsCorrect: physicsCorrect,
                physicsIncorrect: physicsIncorrect,
                physicsMarked: physicsMarkedCount,
                physicsAccuracy: physicsAccuracy,
                mathsCorrect: mathsCorrect,
                mathsIncorrect: mathsIncorrect,
                mathsMarked: mathsMarkedCount,
                mathsAccuracy: mathsAccuracy,
                chemistryCorrect: chemistryCorrect,
                chemistryIncorrect: chemistryIncorrect,
                chemistryMarked: chemistryMarkedCount,
                chemistryAccuracy: chemistryAccuracy,
                subjectScores: {
                    physics: physicsScore,
                    maths: mathsScore,
                    chemistry: chemistryScore
                },
                subjectTimeSpent: {
                    physics: physicsTimeSpent,
                    maths: mathsTimeSpent,
                    chemistry: chemistryTimeSpent
                },
                questionTimeSpent: timeSpent,  // Per-question time array
                // Detailed question-wise data
                physicsAnswers: physicsAnswers,
                mathsAnswers: mathsAnswers,
                chemistryAnswers: chemistryAnswers,
                physicsKey: physicsKey,
                mathsKey: mathsKey,
                chemistryKey: chemistryKey,
                physicsMarkedArray: physicsMarked,
                mathsMarkedArray: mathsMarked,
                chemistryMarkedArray: chemistryMarked
            };
            
            console.log('Saving test data:', testData);
            console.log('Subject Time Spent - Physics:', physicsTimeSpent, 'Maths:', mathsTimeSpent, 'Chemistry:', chemistryTimeSpent);
            
            addTestToHistory(testData);
            
            // Hide test container, show final screen
            document.getElementById('test-container').style.display = 'none';
            document.getElementById('final-screen').style.display = 'block';
        }
        
        // Close results modal
        function closeResults() {
            document.getElementById('results-modal').style.display = 'none';
        }
        
        // View results again
        function viewResultsAgain() {
            document.getElementById('final-screen').style.display = 'none';
            document.getElementById('results-modal').style.display = 'flex';
        }
        
        // Start new test
        function startNewTest() {
            // Reset all variables
            currentQuestion = 1;
            currentSubject = 'physics';
            currentImageIndex = 0;
            manualImageChange = false; // Reset manual image change flag
            isSubjectSwitching = false; // Reset subject switching flag
            totalSeconds = customTime * 60;
            startTime = new Date();
            questionStartTime = new Date();
            testStarted = false;
            testSubmitted = false;
            
            // Reset subject memory
            subjectMemory = {
                physics: { lastQuestion: 1, lastImageIndex: 0 },
                maths: { lastQuestion: null, lastImageIndex: 0 },
                chemistry: { lastQuestion: null, lastImageIndex: 0 }
            };
            
            physicsAnswers = new Array(physicsCount).fill('');
            mathsAnswers = new Array(mathsCount).fill('');
            chemistryAnswers = new Array(chemistryCount).fill('');
            
            physicsMarked = new Array(physicsCount).fill(false);
            mathsMarked = new Array(mathsCount).fill(false);
            chemistryMarked = new Array(chemistryCount).fill(false);
            
            timeSpent = new Array(totalQuestions).fill(0);
            
            // Reset UI
            document.getElementById('timer').textContent = '180:00';
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
                option.style.pointerEvents = 'auto';
            });
            
            document.querySelectorAll('.palette-btn').forEach(btn => {
                btn.style.pointerEvents = 'auto';
            });
            
            document.getElementById('prev-btn').disabled = false;
            document.getElementById('next-btn').disabled = false;
            document.getElementById('mark-review-btn').disabled = false;
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('submit-btn').style.opacity = '0.4';
            document.getElementById('submit-btn').style.cursor = 'not-allowed';
            // Reset confirm checkbox
            const confirmCheck = document.getElementById('submit-confirm-check');
            if (confirmCheck) { confirmCheck.checked = false; }
            document.getElementById('prev-image-btn').disabled = false;
            document.getElementById('next-image-btn').disabled = false;
            
            // Reset answer inputs
            document.getElementById('physics-answers-input').value = '';
            document.getElementById('maths-answers-input').value = '';
            document.getElementById('chemistry-answers-input').value = '';
            document.getElementById('physics-answers-length').textContent = '0';
            document.getElementById('maths-answers-length').textContent = '0';
            document.getElementById('chemistry-answers-length').textContent = '0';
            
            // Hide all modals and final screen
            document.getElementById('submission-modal').style.display = 'none';
            document.getElementById('results-modal').style.display = 'none';
            document.getElementById('final-screen').style.display = 'none';
            
            // Show login screen
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('test-container').style.display = 'none';
        }
        
        // Toggle Question Palette visibility
        function togglePalette() {
            const palette = document.getElementById('question-palette');
            const btn = document.getElementById('palette-toggle-btn');
            
            if (palette.classList.contains('show')) {
                palette.classList.remove('show');
                btn.innerHTML = 'üìã Show Question Palette';
            } else {
                palette.classList.add('show');
                btn.innerHTML = '‚úñÔ∏è Hide Question Palette';
            }
        }
        
        // View test history from login screen
        function viewTestHistory() {
            showTestHistory();
            document.getElementById('history-modal').style.display = 'flex';
        }
    </script>
    <!-- Fullscreen Image Overlay -->
    <div id="img-fullscreen-overlay" onclick="closeFullscreen()">
        <span id="img-fullscreen-close" onclick="closeFullscreen()">‚úï</span>
        <img id="img-fullscreen-img" src="" alt="Question Fullscreen" onclick="event.stopPropagation()">
        <div id="img-fullscreen-hint">Tap anywhere to close ‚Ä¢ Esc bhi kaam karega</div>
    </div>

</body>
</html>